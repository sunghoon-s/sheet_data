<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì œí’ˆêµ°ë³„/ì›”ë³„ ìƒì‚°ì„± ë¶„ì„ - V/SPOOL ì‘ì—…ì¼ë³´</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.98);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 25px 80px rgba(0, 0, 0, 0.15);
            backdrop-filter: blur(20px);
        }
        
        .header {
            text-align: center;
            margin-bottom: 40px;
            position: relative;
        }
        
        .main-title {
            font-size: 48px;
            font-weight: 900;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
        }
        
        .subtitle {
            font-size: 24px;
            color: #4a5568;
            font-weight: 600;
            margin-bottom: 30px;
        }
        
        .pdf-export {
            position: absolute;
            top: 0;
            right: 0;
            padding: 12px 24px;
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
            color: white;
            border: none;
            border-radius: 25px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 8px 25px rgba(255, 107, 107, 0.3);
            display: none;
        }
        
        .pdf-export:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 35px rgba(255, 107, 107, 0.4);
        }
        
        .upload-section {
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            border: 3px dashed #4299e1;
            border-radius: 20px;
            padding: 40px;
            text-align: center;
            margin-bottom: 30px;
            transition: all 0.3s ease;
        }
        
        .upload-section:hover {
            border-color: #3182ce;
            background: linear-gradient(135deg, #e6fffa 0%, #b2f5ea 100%);
        }
        
        .upload-icon {
            font-size: 72px;
            margin-bottom: 20px;
            color: #4299e1;
        }
        
        .file-input-wrapper {
            position: relative;
            display: inline-block;
            margin: 20px 0;
        }
        
        .file-input {
            position: absolute;
            opacity: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
        }
        
        .file-input-label {
            display: inline-block;
            padding: 18px 36px;
            background: linear-gradient(135deg, #4299e1 0%, #3182ce 100%);
            color: white;
            border-radius: 50px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 10px 30px rgba(66, 153, 225, 0.3);
        }
        
        .file-input-label:hover {
            background: linear-gradient(135deg, #3182ce 0%, #2c5282 100%);
            transform: translateY(-3px);
            box-shadow: 0 15px 40px rgba(66, 153, 225, 0.4);
        }
        
        .controls {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .analyze-btn {
            padding: 18px 36px;
            background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
            color: white;
            border: none;
            border-radius: 50px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 10px 30px rgba(72, 187, 120, 0.3);
            margin: 0 10px;
        }
        
        .analyze-btn:hover:not(:disabled) {
            background: linear-gradient(135deg, #38a169 0%, #2f855a 100%);
            transform: translateY(-3px);
            box-shadow: 0 15px 40px rgba(72, 187, 120, 0.4);
        }
        
        .analyze-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        
        .file-info {
            background: linear-gradient(135deg, #e6fffa 0%, #b2f5ea 100%);
            border-left: 6px solid #38b2ac;
            padding: 20px;
            margin: 20px 0;
            border-radius: 12px;
            display: none;
        }
        
        .file-info h4 {
            color: #2c7a7b;
            margin-bottom: 10px;
            font-size: 18px;
            font-weight: 700;
        }
        
        #result-container {
            display: none;
            margin-top: 40px;
        }
        
        .analysis-section {
            margin-bottom: 50px;
            background: white;
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.08);
            border: 2px solid #e2e8f0;
            transition: all 0.3s ease;
        }
        
        .analysis-section:hover {
            transform: translateY(-5px);
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.12);
            border-color: #4299e1;
        }
        
        .section-title {
            font-size: 32px;
            font-weight: 800;
            margin-bottom: 30px;
            text-align: center;
            color: #2d3748;
            text-shadow: 1px 1px 3px rgba(0,0,0,0.1);
        }
        
        .process-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 25px;
            margin-bottom: 40px;
        }
        
        .summary-card {
            background: linear-gradient(135deg, #ffffff 0%, #f7fafc 100%);
            border: 2px solid #e2e8f0;
            border-radius: 16px;
            padding: 30px;
            text-align: center;
            transition: all 0.3s ease;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.06);
        }
        
        .summary-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.12);
            border-color: #4299e1;
        }
        
        .summary-number {
            font-size: 42px;
            font-weight: 900;
            color: #4299e1;
            margin-bottom: 10px;
            text-shadow: 1px 1px 3px rgba(0,0,0,0.1);
        }
        
        .summary-label {
            font-size: 18px;
            color: #4a5568;
            font-weight: 600;
        }
        
        .process-analysis {
            margin-bottom: 60px;
            padding: 50px;
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            border-radius: 20px;
            border: 3px solid #cbd5e0;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.08);
        }
        
        .process-title {
            font-size: 36px;
            font-weight: 800;
            color: white;
            margin-bottom: 40px;
            text-align: center;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 15px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        
        .analysis-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 30px;
            margin-bottom: 40px;
        }
        
        .analysis-card {
            background: white;
            border-radius: 16px;
            padding: 30px;
            box-shadow: 0 12px 30px rgba(0, 0, 0, 0.1);
            border: 2px solid #e2e8f0;
            transition: all 0.3s ease;
        }
        
        .analysis-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 20px 45px rgba(0, 0, 0, 0.15);
            border-color: #4299e1;
        }
        
        .card-title {
            font-size: 24px;
            font-weight: 700;
            color: #2d3748;
            margin-bottom: 20px;
            text-align: center;
        }
        
        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            font-size: 14px;
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.08);
        }
        
        .data-table th {
            background: linear-gradient(135deg, #4299e1 0%, #3182ce 100%);
            color: white;
            padding: 18px 12px;
            text-align: center;
            font-weight: 700;
            font-size: 16px;
            border: none;
        }
        
        .data-table td {
            padding: 15px 12px;
            text-align: center;
            border-bottom: 1px solid #e2e8f0;
            font-weight: 600;
        }
        
        .data-table tbody tr:hover {
            background-color: #f7fafc;
        }
        
        .data-table tbody tr:nth-child(even) {
            background-color: #f8fafc;
        }
        
        .metric-value {
            font-size: 24px;
            font-weight: 800;
            color: #4299e1;
            margin-bottom: 8px;
        }
        
        .metric-label {
            font-size: 16px;
            color: #4a5568;
            font-weight: 600;
        }
        
        .loading {
            text-align: center;
            padding: 60px;
            font-size: 24px;
            color: #4a5568;
            background: linear-gradient(135deg, #f0f4f8 0%, #d6f5d6 100%);
            border-radius: 16px;
            margin: 40px 0;
            animation: pulse 2s ease-in-out infinite;
        }
        
        .error {
            background: linear-gradient(135deg, #fed7d7 0%, #fbb6ce 100%);
            border: 3px solid #f56565;
            color: #c53030;
            padding: 25px;
            border-radius: 16px;
            margin: 25px 0;
            font-weight: 600;
            font-size: 18px;
        }
        
        .success {
            background: linear-gradient(135deg, #c6f6d5 0%, #9ae6b4 100%);
            border: 3px solid #68d391;
            color: #2f855a;
            padding: 25px;
            border-radius: 16px;
            margin: 25px 0;
            font-weight: 600;
            font-size: 18px;
        }
        
        /* ë°˜ì‘í˜• ë””ìì¸ */
        @media (max-width: 1024px) {
            .main-title { font-size: 36px; }
            .subtitle { font-size: 20px; }
            .pdf-export { position: relative; margin-top: 20px; }
        }
        
        @media (max-width: 768px) {
            .container { padding: 20px; }
            .main-title { font-size: 28px; }
            .upload-section { padding: 25px; }
            .analysis-grid { grid-template-columns: 1fr; gap: 20px; }
            .process-summary { grid-template-columns: 1fr; }
        }
        
        /* ì• ë‹ˆë©”ì´ì…˜ */
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .analysis-section {
            animation: fadeInUp 0.6s ease forwards;
        }
        
        .analysis-section:nth-child(1) { animation-delay: 0.1s; }
        .analysis-section:nth-child(2) { animation-delay: 0.2s; }
        .analysis-section:nth-child(3) { animation-delay: 0.3s; }
        .analysis-section:nth-child(4) { animation-delay: 0.4s; }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        
        /* ê³µì •ë³„ ë°ì´í„° ë·°ì–´ ìŠ¤íƒ€ì¼ */
        .process-data-btn {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            border: none;
            border-radius: 12px;
            padding: 8px 16px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            margin-left: 15px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3);
        }
        
        .process-data-btn:hover {
            background: linear-gradient(135deg, #059669 0%, #047857 100%);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(16, 185, 129, 0.4);
        }
        
        .process-data-viewer {
            display: none;
            margin-top: 30px;
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            border: 2px solid #e5e7eb;
        }
        
        .process-data-viewer.show {
            display: block;
            animation: slideDown 0.3s ease-out;
        }
        
        .data-viewer-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e5e7eb;
        }
        
        .data-viewer-title {
            font-size: 20px;
            font-weight: 700;
            color: #1f2937;
        }
        
        .close-viewer-btn {
            background: #ef4444;
            color: white;
            border: none;
            border-radius: 8px;
            padding: 6px 12px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .close-viewer-btn:hover {
            background: #dc2626;
        }
        
        .spreadsheet-container {
            overflow: auto;
            max-height: 500px;
            border: 1px solid #d1d5db;
            border-radius: 8px;
        }
        
        .spreadsheet-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
            background: white;
        }
        
        .spreadsheet-table th {
            background: #f3f4f6;
            color: #374151;
            padding: 12px 8px;
            text-align: center;
            font-weight: 600;
            border: 1px solid #d1d5db;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        .spreadsheet-table td {
            padding: 10px 8px;
            text-align: center;
            border: 1px solid #e5e7eb;
            background: white;
        }
        
        .spreadsheet-table tbody tr:nth-child(even) {
            background: #f9fafb;
        }
        
        .spreadsheet-table tbody tr:hover {
            background: #ecfdf5;
        }
        
        .data-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .summary-item {
            background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            border: 1px solid #93c5fd;
        }
        
        .summary-item-value {
            font-size: 18px;
            font-weight: 700;
            color: #1e40af;
            margin-bottom: 5px;
        }
        
        .summary-item-label {
            font-size: 12px;
            color: #1f2937;
            font-weight: 600;
        }
        
        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1 class="main-title">ì œí’ˆêµ°ë³„/ì›”ë³„ ìƒì‚°ì„± ë¶„ì„</h1>
            <p class="subtitle">V/SPOOL ì‘ì—…ì¼ë³´ í†µí•© ë¶„ì„ ì‹œìŠ¤í…œ</p>
            <button class="pdf-export" id="exportPDF" onclick="exportToPDF()">ğŸ“„ PDF ì €ì¥</button>
        </div>
        
        <div class="upload-section">
            <div class="upload-icon">ğŸ“Š</div>
            <h3>ì—‘ì…€ íŒŒì¼ì„ ì—…ë¡œë“œí•˜ì„¸ìš”</h3>
            <p>V/SPOOL ì‘ì—…ì¼ë³´ ë°ì´í„°ë¥¼ ë¶„ì„í•©ë‹ˆë‹¤</p>
            <div class="file-input-wrapper">
                <input type="file" id="fileInput" class="file-input" accept=".xlsx,.xls,.csv" />
                <label for="fileInput" class="file-input-label">ğŸ“ íŒŒì¼ ì„ íƒ</label>
            </div>
        </div>
        
        <div class="file-info" id="fileInfo">
            <h4>íŒŒì¼ ì •ë³´</h4>
            <p id="fileDetails"></p>
        </div>
        
        <div class="controls">
            <button class="analyze-btn" id="analyzeBtn" onclick="analyzeData()" disabled>
                ğŸ” ë°ì´í„° ë¶„ì„ ì‹œì‘
            </button>
        </div>
        
        <div id="result-container">
            <div class="analysis-section">
                <h2 class="section-title">ğŸ“Š 2) ìƒì‚° í˜„í™© ì¢…í•©</h2>
                <div class="process-summary" id="productionSummary">
                    <!-- ë™ì  ìƒì„± -->
                </div>
            </div>
            
            <div id="processAnalysisContainer">
                <!-- 1) ê³µì •ë³„ ë¶„ì„ì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ìƒì„±ë©ë‹ˆë‹¤ -->
            </div>
            
            <div class="analysis-section">
                <h2 class="section-title">ğŸ”§ 3) ì„¤ë¹„ ë¶„ì„</h2>
                <div id="equipmentAnalysis">
                    <!-- ë™ì  ìƒì„± -->
                </div>
            </div>
            
            <div class="analysis-section">
                <h2 class="section-title">ğŸ“ 4) ì œí’ˆ ê·œê²©ë³„ ë¶„ì„</h2>
                <div id="productAnalysis">
                    <!-- ë™ì  ìƒì„± -->
                </div>
            </div>
        </div>
    </div>

    <script>
        let excelData = [];
        let fileName = '';
        let processMapping = {};

        // íŒŒì¼ ì—…ë¡œë“œ ì²˜ë¦¬
        document.getElementById('fileInput').addEventListener('change', function(event) {
            const file = event.target.files[0];
            if (file) {
                fileName = file.name;
                document.getElementById('fileDetails').textContent = `íŒŒì¼ëª…: ${file.name} | í¬ê¸°: ${(file.size / 1024).toFixed(2)} KB`;
                document.getElementById('fileInfo').style.display = 'block';
                document.getElementById('analyzeBtn').disabled = false;
                loadExcelFile(file);
            }
        });

        // ì—‘ì…€ íŒŒì¼ ë¡œë“œ
        function loadExcelFile(file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    
                    // ì‹œíŠ¸ ë²”ìœ„ í™•ì¸
                    const range = XLSX.utils.decode_range(firstSheet['!ref'] || 'A1');
                    console.log('ğŸ“Š ì‹œíŠ¸ ë²”ìœ„:', `${range.s.r + 1}í–‰ ~ ${range.e.r + 1}í–‰, ${range.s.c + 1}ì—´ ~ ${range.e.c + 1}ì—´`);
                    
                    // ë°°ì—´ í˜•íƒœë¡œ ë°ì´í„° ì½ê¸° (ì ˆëŒ€ì  ê·œì¹™: ì „ì²´ ë°ì´í„° ë°˜ì˜)
                    const rawData = XLSX.utils.sheet_to_json(firstSheet, { 
                        header: 1,
                        defval: "",
                        raw: false,
                        range: 0  // ì²« ë²ˆì§¸ í–‰ë¶€í„° ëê¹Œì§€ ëª¨ë“  ë°ì´í„° ì½ê¸°
                    });
                    
                    console.log('ğŸ” ì›ì‹œ ë°ì´í„° ì´ í–‰ìˆ˜:', rawData.length);
                    console.log('ğŸ“ ì²« ë²ˆì§¸ í–‰(í—¤ë”):', rawData[0]);
                    
                    if (rawData.length > 1) {
                        const headers = rawData[0].filter(h => h && h.toString().trim() !== ''); // ë¹ˆ í—¤ë” ì œê±°
                        const dataRows = rawData.slice(1);
                        
                        console.log('ğŸ“‹ í•„í„°ë§ëœ í—¤ë”:', headers);
                        console.log('ğŸ“Š ë°ì´í„° í–‰ìˆ˜ (í—¤ë” ì œì™¸):', dataRows.length);
                        
                        // ë§ˆì§€ë§‰ ì„¤ë¹„ ì»¬ëŸ¼ ì œì™¸ (ìš”êµ¬ì‚¬í•­)
                        const filteredHeaders = headers.slice(0, -1);
                        console.log('ğŸ”§ ë§ˆì§€ë§‰ ì»¬ëŸ¼ ì œì™¸ í›„ í—¤ë”:', filteredHeaders);
                        
                        // ë¹ˆ í–‰ ê°œìˆ˜ ì¶”ì 
                        let emptyRowCount = 0;
                        let processFilteredCount = 0;
                        
                        // ë°ì´í„° ì •ì œ ë° ë³€í™˜
                        excelData = dataRows.map((row, index) => {
                            // ì™„ì „íˆ ë¹ˆ í–‰ ì²´í¬
                            const isEmptyRow = row.every(cell => !cell || cell.toString().trim() === '');
                            if (isEmptyRow) {
                                emptyRowCount++;
                                return null;
                            }
                            
                            const obj = {};
                            filteredHeaders.forEach((header, headerIndex) => {
                                obj[header] = row[headerIndex] || "";
                            });
                            return obj;
                        }).filter(row => {
                            if (!row) return false; // null ì œê±° (ë¹ˆ í–‰)
                            
                            // ê³µì •ëª…ì´ ë¹„ì–´ìˆìœ¼ë©´ í•´ë‹¹ í–‰ ì‚­ì œ (ìš”êµ¬ì‚¬í•­)
                            const processColumn = findColumn(filteredHeaders, ['ê³µì •ëª…', 'ê³µì •', 'process']);
                            const hasProcess = processColumn && row[processColumn] && row[processColumn].toString().trim() !== '';
                            if (!hasProcess) {
                                processFilteredCount++;
                                return false;
                            }
                            return true;
                        }).map(row => {
                            // ë‚˜ë¨¸ì§€ ë¹ˆ ì…€ì€ '0'ìœ¼ë¡œ ìˆ˜ì • (ìš”êµ¬ì‚¬í•­)
                            Object.keys(row).forEach(key => {
                                if (row[key] === "" || row[key] === null || row[key] === undefined) {
                                    row[key] = "0";
                                }
                            });
                            return row;
                        });
                        
                        console.log('âœ… ì „ì²´ ë°ì´í„° ë¡œë“œ ì™„ë£Œ');
                        console.log('ğŸ“Š ìµœì¢… ë°ì´í„° í–‰ìˆ˜:', excelData.length);
                        console.log('ğŸ—‘ï¸ ì œê±°ëœ ë¹ˆ í–‰:', emptyRowCount);
                        console.log('ğŸ—‘ï¸ ê³µì •ëª… ì—†ì–´ì„œ ì œê±°ëœ í–‰:', processFilteredCount);
                        console.log('ğŸ“ í—¤ë”:', filteredHeaders);
                        console.log('ğŸ“‹ ìƒ˜í”Œ ë°ì´í„°:', excelData.slice(0, 3));
                        
                        // ë°ì´í„° ê²€ì¦
                        const productionColumn = findColumn(filteredHeaders, ['ìƒì‚°ìˆ˜ëŸ‰', 'production', 'quantity', 'ìˆ˜ëŸ‰']);
                        if (productionColumn) {
                            const totalCheck = excelData.reduce((sum, row) => {
                                const val = parseFloat(row[productionColumn]) || 0;
                                return sum + val;
                            }, 0);
                            console.log('ğŸ”¢ ìƒì‚°ìˆ˜ëŸ‰ í•©ê³„ ê²€ì¦:', totalCheck.toLocaleString());
                        }
                        
                        // ê³µì •ë²ˆí˜¸ì™€ ê³µì •ëª… ë§¤í•‘ ìƒì„±
                        processMapping = createProcessMapping(excelData, filteredHeaders);
                        console.log('ğŸ”— ê³µì • ë§¤í•‘:', processMapping);
                        
                        document.getElementById('fileInfo').innerHTML = `
                            <h4>âœ… íŒŒì¼ ë¡œë“œ ì™„ë£Œ</h4>
                            <p>íŒŒì¼ëª…: ${file.name}</p>
                            <p>ì›ì‹œ ë°ì´í„°: ${rawData.length - 1}í–‰ â†’ í•„í„°ë§ í›„: ${excelData.length}í–‰</p>
                            <p>ì»¬ëŸ¼ ìˆ˜: ${filteredHeaders.length}ê°œ</p>
                            <p>ë¹ˆ í–‰ ì œê±°: ${emptyRowCount}ê°œ, ê³µì •ëª… ì—†ëŠ” í–‰ ì œê±°: ${processFilteredCount}ê°œ</p>
                        `;
                    }
                } catch (error) {
                    console.error('âŒ íŒŒì¼ ì½ê¸° ì˜¤ë¥˜:', error);
                    document.getElementById('fileInfo').innerHTML = `
                        <h4 style="color: #c53030;">âŒ íŒŒì¼ ì½ê¸° ì˜¤ë¥˜</h4>
                        <p style="color: #c53030;">${error.message}</p>
                    `;
                }
            };
            reader.readAsArrayBuffer(file);
        }

        // ì»¬ëŸ¼ ì°¾ê¸° ìœ í‹¸ë¦¬í‹°
        function findColumn(headers, keywords) {
            return headers.find(header => 
                keywords.some(keyword => 
                    header && header.toString().toLowerCase().includes(keyword.toLowerCase())
                )
            );
        }

        // ê³µì •ë²ˆí˜¸ì™€ ê³µì •ëª… ë§¤í•‘ ìƒì„±
        function createProcessMapping(data, headers) {
            const processColumn = findColumn(headers, ['ê³µì •ëª…', 'ê³µì •', 'process']);
            const itemColumn = findColumn(headers, ['í’ˆëª©', 'item', 'product', 'ì œí’ˆ']);
            const mapping = {};
            
            if (!itemColumn || !processColumn) {
                console.warn('âš ï¸ í’ˆëª© ë˜ëŠ” ê³µì •ëª… ì»¬ëŸ¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                return mapping;
            }
            
            data.forEach(row => {
                const processName = row[processColumn];
                const itemCode = row[itemColumn];
                
                if (processName && itemCode) {
                    const processNumber = extractProcessNumber(itemCode);
                    if (processNumber && !mapping[processName]) {
                        mapping[processName] = processNumber;
                    }
                }
            });
            
            return mapping;
        }

        // í’ˆëª© ì½”ë“œì—ì„œ ë§ˆì§€ë§‰ 3ìë¦¬ ì¶”ì¶œ
        function extractProcessNumber(itemCode) {
            if (!itemCode) return null;
            
            const codeStr = itemCode.toString();
            const numbers = codeStr.replace(/[^\d]/g, '');
            
            if (numbers.length >= 3) {
                return numbers.slice(-3);
            }
            
            return null;
        }

        // ë°ì´í„° ë¶„ì„
        function analyzeData() {
            if (excelData.length === 0) {
                alert('âŒ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤. ë¨¼ì € íŒŒì¼ì„ ì—…ë¡œë“œí•´ì£¼ì„¸ìš”.');
                return;
            }
            
            console.log('ğŸš€ ë°ì´í„° ë¶„ì„ ì‹œì‘');
            console.log('ğŸ“Š ë¶„ì„í•  ë°ì´í„°:', excelData.length, 'í–‰');
            
            // ë¡œë”© í‘œì‹œ
            document.getElementById('result-container').innerHTML = '<div class="loading">ğŸ”„ ë°ì´í„° ë¶„ì„ ì¤‘...</div>';
            document.getElementById('result-container').style.display = 'block';
            
            setTimeout(() => {
                try {
                    const headers = Object.keys(excelData[0]);
                    console.log('ğŸ” ë¶„ì„ ì‹œì‘ - í—¤ë”:', headers);
                    
                    const processColumn = findColumn(headers, ['ê³µì •ëª…', 'ê³µì •', 'process']);
                    const productionColumn = findColumn(headers, ['ìƒì‚°ìˆ˜ëŸ‰', 'production', 'quantity', 'ìˆ˜ëŸ‰']);
                    
                    console.log('ğŸ”§ í•µì‹¬ ì»¬ëŸ¼ í™•ì¸:');
                    console.log('- ê³µì •ëª… ì»¬ëŸ¼:', processColumn);
                    console.log('- ìƒì‚°ìˆ˜ëŸ‰ ì»¬ëŸ¼:', productionColumn);
                    
                    if (!processColumn || !productionColumn) {
                        throw new Error(`í•„ìˆ˜ ì»¬ëŸ¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.\nê³µì •ëª…: ${processColumn}\nìƒì‚°ìˆ˜ëŸ‰: ${productionColumn}`);
                    }
                    
                    // ì „ì²´ ë°ì´í„° ê²€ì¦ - ë” ìƒì„¸í•œ ë¶„ì„
                    let totalProductionCheck = 0;
                    let positiveProductionCheck = 0;
                    let negativeProductionCheck = 0;
                    let zeroProductionCount = 0;
                    let validProductionRows = 0;
                    let uniqueProcesses = new Set();
                    let processDistribution = {};
                    
                    console.log('ğŸ” ì „ì²´ ë°ì´í„° ìƒì„¸ ê²€ì¦:');
                    excelData.forEach((row, index) => {
                        const production = parseFloat(row[productionColumn]) || 0;
                        const processName = row[processColumn];
                        
                        totalProductionCheck += production;
                        
                        if (production > 0) {
                            positiveProductionCheck += production;
                            validProductionRows++;
                        } else if (production < 0) {
                            negativeProductionCheck += production;
                        } else {
                            zeroProductionCount++;
                        }
                        
                        if (processName && processName !== '0' && processName.toString().trim() !== '') {
                            uniqueProcesses.add(processName);
                            if (!processDistribution[processName]) {
                                processDistribution[processName] = { count: 0, totalProduction: 0 };
                            }
                            processDistribution[processName].count++;
                            processDistribution[processName].totalProduction += production;
                        }
                        
                        // ì²˜ìŒ 5ê°œ í–‰ ìƒì„¸ ì¶œë ¥
                        if (index < 5) {
                            console.log(`ì „ì²´ê²€ì¦ í–‰ ${index + 1}: ê³µì •="${processName}", ìƒì‚°ìˆ˜ëŸ‰=${production} (ì›ë³¸: "${row[productionColumn]}")`);
                        }
                    });
                    
                    console.log('ğŸ“Š ì „ì²´ ë°ì´í„° ê²€ì¦ ê²°ê³¼:');
                    console.log(`- ì „ì²´ ë°ì´í„° í–‰ìˆ˜: ${excelData.length}ê°œ`);
                    console.log(`- ì´ ìƒì‚°ìˆ˜ëŸ‰ (ìˆœí•©ê³„): ${totalProductionCheck.toLocaleString()}`);
                    console.log(`- ì–‘ìˆ˜ ìƒì‚°ìˆ˜ëŸ‰: ${positiveProductionCheck.toLocaleString()}`);
                    console.log(`- ìŒìˆ˜ ìƒì‚°ìˆ˜ëŸ‰: ${negativeProductionCheck.toLocaleString()}`);
                    console.log(`- ìƒì‚°ìˆ˜ëŸ‰ 0ì¸ í–‰: ${zeroProductionCount}ê°œ`);
                    console.log(`- ì–‘ìˆ˜ ìƒì‚°ìˆ˜ëŸ‰ í–‰: ${validProductionRows}ê°œ`);
                    console.log(`- ê³ ìœ  ê³µì • ìˆ˜: ${uniqueProcesses.size}ê°œ`);
                    console.log(`- ê³ ìœ  ê³µì •ëª…:`, Array.from(uniqueProcesses));
                    
                    // ê³µì •ë³„ ë¶„í¬ ì¶œë ¥
                    console.log('ğŸ” ê³µì •ë³„ ë¶„í¬:');
                    Object.entries(processDistribution).forEach(([processName, data]) => {
                        console.log(`  "${processName}": ${data.totalProduction.toLocaleString()} (${data.count}ê±´)`);
                    });
                    
                    // ë¶„ì„ ê²°ê³¼ ì»¨í…Œì´ë„ˆ ì´ˆê¸°í™”
                    document.getElementById('result-container').innerHTML = `
                        <div class="analysis-section">
                            <h2 class="section-title">ğŸ“Š 2) ìƒì‚° í˜„í™© ì¢…í•©</h2>
                            <div class="process-summary" id="productionSummary">
                                <!-- ë™ì  ìƒì„± -->
                            </div>
                        </div>
                        
                        <div id="processAnalysisContainer">
                            <!-- 1) ê³µì •ë³„ ë¶„ì„ì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ìƒì„±ë©ë‹ˆë‹¤ -->
                        </div>
                        
                        <div class="analysis-section">
                            <h2 class="section-title">ğŸ”§ 3) ì„¤ë¹„ ë¶„ì„</h2>
                            <div id="equipmentAnalysis">
                                <!-- ë™ì  ìƒì„± -->
                            </div>
                        </div>
                        
                        <div class="analysis-section">
                            <h2 class="section-title">ğŸ“ 4) ì œí’ˆ ê·œê²©ë³„ ë¶„ì„</h2>
                            <div id="productAnalysis">
                                <!-- ë™ì  ìƒì„± -->
                            </div>
                        </div>
                    `;
                    
                    document.getElementById('exportPDF').style.display = 'block';
                    
                    // 1) ê³µì •ë³„ ë¶„ì„ (ê³µì •ë²ˆí˜¸ ìˆœì„œëŒ€ë¡œ)
                    generateProcessAnalysis(processColumn, productionColumn, headers);
                    
                    // 2) ìƒì‚° í˜„í™© ì¢…í•©
                    generateProductionSummary(headers);
                    
                    // 3) ì„¤ë¹„ ë¶„ì„
                    generateEquipmentAnalysis(headers);
                    
                    // 4) ì œí’ˆ ê·œê²©ë³„ ë¶„ì„
                    generateProductAnalysis(headers);
                    
                    console.log('âœ… ë¶„ì„ ì™„ë£Œ!');
                    
                } catch (error) {
                    console.error('âŒ ë¶„ì„ ì¤‘ ì˜¤ë¥˜:', error);
                    document.getElementById('result-container').innerHTML = `
                        <div class="error">
                            <h3>âŒ ë¶„ì„ ì˜¤ë¥˜</h3>
                            <p>${error.message}</p>
                        </div>
                    `;
                }
            }, 500);
        }

        // 1) ê³µì •ë³„ ë¶„ì„ ìƒì„±
        function generateProcessAnalysis(processColumn, productionColumn, headers) {
            console.log('ğŸ” ê³µì •ë³„ ë¶„ì„ ì‹œì‘');
            console.log('ğŸ“Š ì‚¬ìš© ì»¬ëŸ¼ - ê³µì •:', processColumn, 'ìƒì‚°ìˆ˜ëŸ‰:', productionColumn);
            
            const processResults = {};
            let grandTotal = 0;
            let processedRowCount = 0;
            let skippedRowCount = 0;
            let totalValidProduction = 0; // ì „ì²´ ìœ íš¨ ìƒì‚°ìˆ˜ëŸ‰ ì¶”ê°€
            
            // ë¨¼ì € ì „ì²´ ë°ì´í„°ì—ì„œ ìƒì‚°ìˆ˜ëŸ‰ í•©ê³„ ê³„ì‚°
            console.log('ğŸ“Š ì „ì²´ ë°ì´í„° ìƒì‚°ìˆ˜ëŸ‰ ê²€ì¦:');
            excelData.forEach((row, index) => {
                const productionValue = parseFloat(row[productionColumn]) || 0;
                if (productionValue !== 0) { // 0ì´ ì•„ë‹Œ ëª¨ë“  ê°’ í¬í•¨
                    totalValidProduction += productionValue;
                }
                
                // ì²˜ìŒ 10ê°œ í–‰ ìƒì„¸ ë¡œê¹…
                if (index < 10) {
                    console.log(`ì „ì²´ê²€ì¦ í–‰ ${index + 1}: ìƒì‚°ìˆ˜ëŸ‰=${productionValue} (ì›ë³¸: "${row[productionColumn]}")`);
                }
            });
            
            console.log(`ğŸ“ˆ ì „ì²´ ë°ì´í„° ìƒì‚°ìˆ˜ëŸ‰ í•©ê³„: ${totalValidProduction.toLocaleString()}`);
            
            // ê³µì •ë³„ ë°ì´í„° ì§‘ê³„ - ë” ì •í™•í•œ ê³„ì‚°
            excelData.forEach((row, index) => {
                const processName = row[processColumn];
                const productionValue = parseFloat(row[productionColumn]) || 0;
                
                // ë””ë²„ê¹…: ì²« 10ê°œ í–‰ì˜ ìƒì„¸ ì •ë³´
                if (index < 10) {
                    console.log(`ê³µì •ë³„ì§‘ê³„ í–‰ ${index + 1}: ê³µì •="${processName}", ìƒì‚°ìˆ˜ëŸ‰=${productionValue} (ì›ë³¸: "${row[productionColumn]}")`);
                }
                
                // ê³µì •ëª…ì´ ìˆëŠ” ê²½ìš°ë§Œ ê³µì •ë³„ë¡œ ì§‘ê³„
                if (processName && processName !== '0' && processName.toString().trim() !== '') {
                    if (!processResults[processName]) {
                        processResults[processName] = {
                            total: 0,
                            count: 0,
                            processNumber: processMapping[processName] || '000',
                            data: []
                        };
                    }
                    
                    // ìƒì‚°ìˆ˜ëŸ‰ì´ 0ì´ì–´ë„ ë°ì´í„°ì— í¬í•¨ (ì‹¤ì œ ì‘ì—… ê¸°ë¡)
                    processResults[processName].total += productionValue;
                    processResults[processName].count += 1;
                    processResults[processName].data.push(row);
                    grandTotal += productionValue;
                    processedRowCount++;
                } else {
                    skippedRowCount++;
                    if (index < 10) {
                        console.log(`âš ï¸ í–‰ ${index + 1} ê±´ë„ˆëœ€: ê³µì •ëª…='${processName}' (ìƒì‚°ìˆ˜ëŸ‰: ${productionValue})`);
                    }
                    
                    // ê³µì •ëª…ì´ ì—†ì–´ë„ ìƒì‚°ìˆ˜ëŸ‰ì´ ìˆë‹¤ë©´ ë³„ë„ ì¶”ì 
                    if (productionValue !== 0) {
                        console.log(`â— ì£¼ì˜: ê³µì •ëª… ì—†ëŠ” í–‰ì—ì„œ ìƒì‚°ìˆ˜ëŸ‰ ${productionValue} ë°œê²¬ (í–‰ ${index + 1})`);
                    }
                }
            });
            
            console.log('ğŸ“Š ì§‘ê³„ ê²°ê³¼:');
            console.log(`- ì „ì²´ ë°ì´í„° í–‰ìˆ˜: ${excelData.length}ê°œ`);
            console.log(`- ê³µì •ë³„ë¡œ ì²˜ë¦¬ëœ í–‰: ${processedRowCount}ê°œ`);
            console.log(`- ê±´ë„ˆë›´ í–‰ (ê³µì •ëª… ì—†ìŒ): ${skippedRowCount}ê°œ`);
            console.log(`- ê³µì •ë³„ ìƒì‚°ìˆ˜ëŸ‰ í•©ê³„: ${grandTotal.toLocaleString()}`);
            console.log(`- ì „ì²´ ìœ íš¨ ìƒì‚°ìˆ˜ëŸ‰: ${totalValidProduction.toLocaleString()}`);
            console.log(`- ì°¨ì´ (ëˆ„ë½ëœ ìƒì‚°ìˆ˜ëŸ‰): ${(totalValidProduction - grandTotal).toLocaleString()}`);
            console.log(`- ë°œê²¬ëœ ê³µì • ìˆ˜: ${Object.keys(processResults).length}ê°œ`);
            
            // ê° ê³µì •ë³„ ìƒì„¸ í•©ê³„ ì¶œë ¥
            console.log('ğŸ” ê³µì •ë³„ ìƒì„¸ ì§‘ê³„:');
            Object.entries(processResults).forEach(([processName, data]) => {
                console.log(`  "${processName}": ${data.total.toLocaleString()} (${data.count}ê±´)`);
            });
            
            // ê²€ì¦: grandTotalê³¼ ì‹¤ì œ í•©ê³„ ë¹„êµ
            const recalculatedTotal = Object.values(processResults).reduce((sum, process) => sum + process.total, 0);
            console.log(`ğŸ“ˆ ì¬ê³„ì‚°ëœ ê³µì •ë³„ í•©ê³„: ${recalculatedTotal.toLocaleString()}`);
            
            if (Math.abs(grandTotal - recalculatedTotal) > 0.01) {
                console.warn('âš ï¸ ê³µì •ë³„ í•©ê³„ ë¶ˆì¼ì¹˜ ë°œê²¬!');
            }
            
            if (Math.abs(totalValidProduction - grandTotal) > 0.01) {
                console.warn(`âš ï¸ ì „ì²´ vs ê³µì •ë³„ ìƒì‚°ìˆ˜ëŸ‰ ì°¨ì´: ${(totalValidProduction - grandTotal).toLocaleString()}`);
                console.warn('ğŸ’¡ ê³µì •ëª…ì´ ì—†ëŠ” ë°ì´í„°ì— ìƒì‚°ìˆ˜ëŸ‰ì´ í¬í•¨ë˜ì–´ ìˆì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
            }
            
            // ê³µì •ë²ˆí˜¸ ìˆœì„œëŒ€ë¡œ ì •ë ¬
            const sortedProcesses = Object.entries(processResults)
                .sort(([,a], [,b]) => {
                    const numA = parseInt(a.processNumber) || 999;
                    const numB = parseInt(b.processNumber) || 999;
                    return numA - numB;
                });
            
            // ê³µì •ë³„ ìƒì„¸ ë¶„ì„ ìƒì„±
            let processHTML = '';
            sortedProcesses.forEach(([processName, data], index) => {
                const percentage = ((data.total / grandTotal) * 100).toFixed(1);
                const displayName = data.processNumber !== '000' ? 
                    `ê³µì •#${data.processNumber} - ${processName}` : processName;
                
                const analysis = analyzeProcessData(data.data, headers);
                const processId = `process_${index}`;
                
                processHTML += `
                    <div class="process-analysis">
                        <div class="process-title">
                            ${index + 1}) ${displayName} ë¶„ì„
                            <button class="process-data-btn" onclick="toggleProcessData('${processId}')">
                                ğŸ“Š ë°ì´í„° ë³´ê¸°
                            </button>
                        </div>
                        
                        <div class="process-data-viewer" id="${processId}">
                            <div class="data-viewer-header">
                                <div class="data-viewer-title">${displayName} - ìƒì„¸ ë°ì´í„°</div>
                                <button class="close-viewer-btn" onclick="toggleProcessData('${processId}')">âœ• ë‹«ê¸°</button>
                            </div>
                            
                            <div class="data-summary">
                                <div class="summary-item">
                                    <div class="summary-item-value">${data.total.toLocaleString()}</div>
                                    <div class="summary-item-label">ì´ ìƒì‚°ìˆ˜ëŸ‰</div>
                                </div>
                                <div class="summary-item">
                                    <div class="summary-item-value">${data.count}</div>
                                    <div class="summary-item-label">ë°ì´í„° í–‰ìˆ˜</div>
                                </div>
                                <div class="summary-item">
                                    <div class="summary-item-value">${percentage}%</div>
                                    <div class="summary-item-label">ì „ì²´ ëŒ€ë¹„ ë¹„ìœ¨</div>
                                </div>
                                <div class="summary-item">
                                    <div class="summary-item-value">${(data.total / data.count).toFixed(0)}</div>
                                    <div class="summary-item-label">í‰ê·  ìƒì‚°ëŸ‰</div>
                                </div>
                            </div>
                            
                            <div class="spreadsheet-container">
                                ${generateProcessSpreadsheet(data.data, headers)}
                            </div>
                        </div>
                        
                        <div class="analysis-grid">
                            <div class="analysis-card">
                                <div class="card-title">ğŸ“Š ìƒì‚° í˜„í™©</div>
                                <div class="metric-value">${data.total.toLocaleString()}</div>
                                <div class="metric-label">ì´ ìƒì‚°ìˆ˜ëŸ‰ (${percentage}%)</div>
                                <div style="margin-top: 15px;">
                                    <div style="font-size: 20px; font-weight: 700; color: #38b2ac;">${data.count}ê±´</div>
                                    <div style="color: #4a5568;">ì‘ì—… ê±´ìˆ˜</div>
                                </div>
                            </div>
                            ${generateAnalysisCards(analysis)}
                        </div>
                        ${generateDetailedTables(analysis)}
                    </div>
                `;
            });
            
            document.getElementById('processAnalysisContainer').innerHTML = processHTML;
        }

        // ê³µì • ë°ì´í„° ë¶„ì„
        function analyzeProcessData(processData, headers) {
            const equipmentColumn = findColumn(headers, ['ì„¤ë¹„', 'equipment', 'machine']);
            const workerColumn = findColumn(headers, ['ì‘ì—…ì', 'worker', 'operator']);
            const specColumn = findColumn(headers, ['ê·œê²©', 'spec', 'model']);
            const productionColumn = findColumn(headers, ['ìƒì‚°ìˆ˜ëŸ‰', 'production', 'quantity']);
            const ctColumn = findColumn(headers, ['CT', 'C/T', 'cycletime']);
            const defectColumn = findColumn(headers, ['ë¶ˆëŸ‰', 'defect']);
            const efficiencyColumn = findColumn(headers, ['íš¨ìœ¨', 'efficiency']);
            
            const analysis = {
                equipment: {},
                workers: {},
                specs: {},
                totalProduction: 0,
                totalRecords: processData.length
            };
            
            processData.forEach(row => {
                const production = parseFloat(row[productionColumn]) || 0;
                analysis.totalProduction += production;
                
                // ì„¤ë¹„ë³„ ë¶„ì„
                if (equipmentColumn && row[equipmentColumn] && row[equipmentColumn] !== '0') {
                    const equipment = row[equipmentColumn];
                    if (!analysis.equipment[equipment]) {
                        analysis.equipment[equipment] = { 
                            production: 0, 
                            count: 0,
                            defect: 0,
                            efficiency: 0,
                            ctTotal: 0
                        };
                    }
                    analysis.equipment[equipment].production += production;
                    analysis.equipment[equipment].count += 1;
                    if (defectColumn) analysis.equipment[equipment].defect += parseFloat(row[defectColumn]) || 0;
                    if (efficiencyColumn) analysis.equipment[equipment].efficiency += parseFloat(row[efficiencyColumn]) || 0;
                    if (ctColumn) analysis.equipment[equipment].ctTotal += parseFloat(row[ctColumn]) || 0;
                }
                
                // ì‘ì—…ìë³„ ë¶„ì„
                if (workerColumn && row[workerColumn] && row[workerColumn] !== '0') {
                    const worker = row[workerColumn];
                    if (!analysis.workers[worker]) {
                        analysis.workers[worker] = { production: 0, count: 0 };
                    }
                    analysis.workers[worker].production += production;
                    analysis.workers[worker].count += 1;
                }
                
                // ê·œê²©ë³„ ë¶„ì„
                if (specColumn && row[specColumn] && row[specColumn] !== '0') {
                    const spec = row[specColumn];
                    if (!analysis.specs[spec]) {
                        analysis.specs[spec] = { 
                            production: 0, 
                            count: 0,
                            ctTotal: 0,
                            defect: 0,
                            efficiency: 0
                        };
                    }
                    analysis.specs[spec].production += production;
                    analysis.specs[spec].count += 1;
                    if (ctColumn) analysis.specs[spec].ctTotal += parseFloat(row[ctColumn]) || 0;
                    if (defectColumn) analysis.specs[spec].defect += parseFloat(row[defectColumn]) || 0;
                    if (efficiencyColumn) analysis.specs[spec].efficiency += parseFloat(row[efficiencyColumn]) || 0;
                }
            });
            
            return analysis;
        }

        // ê³µì •ë³„ ìŠ¤í”„ë ˆë“œì‹œíŠ¸ ìƒì„±
        function generateProcessSpreadsheet(processData, headers) {
            if (!processData || processData.length === 0) {
                return '<p style="text-align: center; color: #6b7280;">ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
            }
            
            let tableHTML = `
                <table class="spreadsheet-table">
                    <thead>
                        <tr>
                            <th style="width: 50px;">ìˆœë²ˆ</th>
            `;
            
            // í—¤ë” ìƒì„±
            headers.forEach(header => {
                tableHTML += `<th>${header}</th>`;
            });
            
            tableHTML += `
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            // ë°ì´í„° í–‰ ìƒì„±
            processData.forEach((row, index) => {
                tableHTML += `<tr><td style="font-weight: 700; background: #f3f4f6;">${index + 1}</td>`;
                headers.forEach(header => {
                    const value = row[header] || '';
                    // ìˆ«ìì¸ ê²½ìš° ì²œë‹¨ìœ„ ì½¤ë§ˆ ì¶”ê°€
                    const displayValue = !isNaN(value) && value !== '' && value !== '0' ? 
                        parseFloat(value).toLocaleString() : value;
                    tableHTML += `<td>${displayValue}</td>`;
                });
                tableHTML += '</tr>';
            });
            
            tableHTML += `
                    </tbody>
                </table>
            `;
            
            return tableHTML;
        }
        
        // ê³µì •ë³„ ë°ì´í„° ë·°ì–´ í† ê¸€
        function toggleProcessData(processId) {
            const viewer = document.getElementById(processId);
            if (viewer) {
                if (viewer.classList.contains('show')) {
                    viewer.classList.remove('show');
                } else {
                    viewer.classList.add('show');
                }
            }
        }
        function generateAnalysisCards(analysis) {
            const equipmentCount = Object.keys(analysis.equipment).length;
            const workerCount = Object.keys(analysis.workers).length;
            const specCount = Object.keys(analysis.specs).length;
            
            return `
                <div class="analysis-card">
                    <div class="card-title">ğŸ”§ ì„¤ë¹„ í˜„í™©</div>
                    <div class="metric-value">${equipmentCount}</div>
                    <div class="metric-label">íˆ¬ì… ì„¤ë¹„ ëŒ€ìˆ˜</div>
                </div>
                <div class="analysis-card">
                    <div class="card-title">ğŸ‘¨â€ğŸ”§ ì¸ë ¥ í˜„í™©</div>
                    <div class="metric-value">${workerCount}</div>
                    <div class="metric-label">íˆ¬ì… ì¸ì› ìˆ˜</div>
                </div>
                <div class="analysis-card">
                    <div class="card-title">ğŸ“ ê·œê²© í˜„í™©</div>
                    <div class="metric-value">${specCount}</div>
                    <div class="metric-label">ìƒì‚° ê·œê²© ìˆ˜</div>
                </div>
            `;
        }

        // ìƒì„¸ í…Œì´ë¸” ìƒì„±
        function generateDetailedTables(analysis) {
            let tablesHTML = '';
            
            // ì„¤ë¹„ë³„ ìƒì„¸ í…Œì´ë¸”
            if (Object.keys(analysis.equipment).length > 0) {
                tablesHTML += `
                    <div style="margin-top: 40px;">
                        <h3 style="text-align: center; margin-bottom: 20px; color: #2d3748;">ğŸ”§ ì„¤ë¹„ë³„ ìƒì„¸ ë¶„ì„</h3>
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>ì„¤ë¹„ëª…</th>
                                    <th>ìƒì‚°ìˆ˜ëŸ‰</th>
                                    <th>í‰ê·  UPH</th>
                                    <th>í‰ê·  CT</th>
                                    <th>í‰ê·  íš¨ìœ¨(%)</th>
                                    <th>ë¶ˆëŸ‰ìœ¨(%)</th>
                                </tr>
                            </thead>
                            <tbody>
                `;
                
                Object.entries(analysis.equipment).forEach(([equipment, data]) => {
                    const avgUPH = data.count > 0 ? (data.production / data.count).toFixed(2) : 0;
                    const avgCT = data.count > 0 ? (data.ctTotal / data.count).toFixed(2) : 0;
                    const avgEfficiency = data.count > 0 ? (data.efficiency / data.count).toFixed(1) : 0;
                    const defectRate = data.production > 0 ? ((data.defect / data.production) * 100).toFixed(2) : 0;
                    
                    tablesHTML += `
                        <tr>
                            <td>${equipment}</td>
                            <td>${data.production.toLocaleString()}</td>
                            <td>${avgUPH}</td>
                            <td>${avgCT}ì´ˆ</td>
                            <td>${avgEfficiency}%</td>
                            <td>${defectRate}%</td>
                        </tr>
                    `;
                });
                
                tablesHTML += '</tbody></table></div>';
            }
            
            // ê·œê²©ë³„ ìƒì„¸ í…Œì´ë¸”
            if (Object.keys(analysis.specs).length > 0) {
                tablesHTML += `
                    <div style="margin-top: 40px;">
                        <h3 style="text-align: center; margin-bottom: 20px; color: #2d3748;">ğŸ“ ê·œê²©ë³„ ìƒì„¸ ë¶„ì„</h3>
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>ê·œê²©</th>
                                    <th>ìƒì‚°ìˆ˜ëŸ‰</th>
                                    <th>í‰ê·  UPH</th>
                                    <th>í‰ê·  C/T</th>
                                    <th>í‰ê·  íš¨ìœ¨2(%)</th>
                                    <th>ë¶ˆëŸ‰ìœ¨(%)</th>
                                </tr>
                            </thead>
                            <tbody>
                `;
                
                Object.entries(analysis.specs).forEach(([spec, data]) => {
                    const avgUPH = data.count > 0 ? (data.production / data.count).toFixed(2) : 0;
                    const avgCT = data.count > 0 ? (data.ctTotal / data.count).toFixed(2) : 0;
                    const avgEfficiency = data.count > 0 ? (data.efficiency / data.count).toFixed(1) : 0;
                    const defectRate = data.production > 0 ? ((data.defect / data.production) * 100).toFixed(2) : 0;
                    
                    tablesHTML += `
                        <tr>
                            <td>${spec}</td>
                            <td>${data.production.toLocaleString()}</td>
                            <td>${avgUPH}</td>
                            <td>${avgCT}ì´ˆ</td>
                            <td>${avgEfficiency}%</td>
                            <td>${defectRate}%</td>
                        </tr>
                    `;
                });
                
                tablesHTML += '</tbody></table></div>';
            }
            
            return tablesHTML;
        }

        // 2) ìƒì‚° í˜„í™© ì¢…í•©
        function generateProductionSummary(headers) {
            console.log('ğŸ“Š ìƒì‚° í˜„í™© ì¢…í•© ë¶„ì„ ì‹œì‘');
            
            const productionColumn = findColumn(headers, ['ìƒì‚°ìˆ˜ëŸ‰', 'production', 'quantity']);
            const equipmentColumn = findColumn(headers, ['ì„¤ë¹„', 'equipment', 'machine']);
            const workerColumn = findColumn(headers, ['ì‘ì—…ì', 'worker', 'operator']);
            const timeColumn = findColumn(headers, ['ì‹œê°„', 'time', 'ì‘ì—…ì‹œê°„']);
            const specColumn = findColumn(headers, ['ê·œê²©', 'spec', 'model']);
            
            console.log('ğŸ”§ ì‚¬ìš© ì»¬ëŸ¼ë“¤:', {
                ìƒì‚°ìˆ˜ëŸ‰: productionColumn,
                ì„¤ë¹„: equipmentColumn,
                ì‘ì—…ì: workerColumn,
                ì‹œê°„: timeColumn,
                ê·œê²©: specColumn
            });
            
            let totalProduction = 0;
            let positiveProduction = 0; // ì–‘ìˆ˜ì¸ ìƒì‚°ìˆ˜ëŸ‰ë§Œ
            let negativeProduction = 0; // ìŒìˆ˜ì¸ ìƒì‚°ìˆ˜ëŸ‰ (ë¶ˆëŸ‰ ë“±)
            const equipmentSet = new Set();
            const workerSet = new Set();
            const specSet = new Set();
            let totalTime = 0;
            let validRowCount = 0;
            let productionRowCount = 0;
            
            console.log('ğŸ” ì¢…í•© ë¶„ì„ ìƒì„¸ ê²€ì¦:');
            excelData.forEach((row, index) => {
                const production = parseFloat(row[productionColumn]) || 0;
                totalProduction += production;
                
                if (production > 0) {
                    positiveProduction += production;
                    productionRowCount++;
                } else if (production < 0) {
                    negativeProduction += production;
                }
                
                if (equipmentColumn && row[equipmentColumn] && row[equipmentColumn] !== '0') {
                    equipmentSet.add(row[equipmentColumn]);
                }
                if (workerColumn && row[workerColumn] && row[workerColumn] !== '0') {
                    workerSet.add(row[workerColumn]);
                }
                if (specColumn && row[specColumn] && row[specColumn] !== '0') {
                    specSet.add(row[specColumn]);
                }
                if (timeColumn) {
                    const time = parseFloat(row[timeColumn]) || 0;
                    totalTime += time;
                }
                
                if (production !== 0) validRowCount++;
                
                // ì²˜ìŒ 10ê°œ í–‰ ë””ë²„ê¹…
                if (index < 10) {
                    console.log(`ì¢…í•©ë¶„ì„ í–‰ ${index + 1}: ìƒì‚°=${production}, ì„¤ë¹„="${row[equipmentColumn]}", ì‘ì—…ì="${row[workerColumn]}", ì‹œê°„=${row[timeColumn]}`);
                }
            });
            
            console.log('ğŸ“Š ì¢…í•© ë¶„ì„ ê²°ê³¼:');
            console.log(`- ì „ì²´ ë°ì´í„° í–‰ìˆ˜: ${excelData.length}ê°œ`);
            console.log(`- ì´ ìƒì‚°ìˆ˜ëŸ‰ (ìˆœí•©ê³„): ${totalProduction.toLocaleString()}`);
            console.log(`- ì–‘ìˆ˜ ìƒì‚°ìˆ˜ëŸ‰: ${positiveProduction.toLocaleString()}`);
            console.log(`- ìŒìˆ˜ ìƒì‚°ìˆ˜ëŸ‰: ${negativeProduction.toLocaleString()}`);
            console.log(`- ìƒì‚°ìˆ˜ëŸ‰ ìˆëŠ” í–‰: ${productionRowCount}ê°œ`);
            console.log(`- ìƒì‚°ìˆ˜ëŸ‰ 0ì´ ì•„ë‹Œ í–‰: ${validRowCount}ê°œ`);
            console.log(`- ì„¤ë¹„ ì¢…ë¥˜: ${equipmentSet.size}ê°œ [${Array.from(equipmentSet).slice(0, 5).join(', ')}${equipmentSet.size > 5 ? '...' : ''}]`);
            console.log(`- ì‘ì—…ì ìˆ˜: ${workerSet.size}ëª… [${Array.from(workerSet).slice(0, 5).join(', ')}${workerSet.size > 5 ? '...' : ''}]`);
            console.log(`- ê·œê²© ì¢…ë¥˜: ${specSet.size}ê°œ [${Array.from(specSet).slice(0, 5).join(', ')}${specSet.size > 5 ? '...' : ''}]`);
            console.log(`- ì´ ì‘ì—…ì‹œê°„: ${totalTime.toLocaleString()}`);
            
            const avgUPH = totalTime > 0 ? (totalProduction / totalTime).toFixed(2) : 'N/A';
            
            // í‘œì‹œìš©ìœ¼ë¡œëŠ” ì–‘ìˆ˜ ìƒì‚°ìˆ˜ëŸ‰ ì‚¬ìš© (ì¼ë°˜ì ìœ¼ë¡œ ë¶ˆëŸ‰ ì œì™¸í•œ ìˆœìƒì‚°ëŸ‰)
            const displayProduction = positiveProduction;
            
            document.getElementById('productionSummary').innerHTML = `
                <div class="summary-card">
                    <div class="summary-number">${displayProduction.toLocaleString()}</div>
                    <div class="summary-label">ì´ ìƒì‚°ìˆ˜ëŸ‰</div>
                </div>
                <div class="summary-card">
                    <div class="summary-number">${equipmentSet.size}</div>
                    <div class="summary-label">íˆ¬ì…ì„¤ë¹„ ëŒ€ìˆ˜</div>
                </div>
                <div class="summary-card">
                    <div class="summary-number">${workerSet.size}</div>
                    <div class="summary-label">íˆ¬ì…ì¸ì› ìˆ˜</div>
                </div>
                <div class="summary-card">
                    <div class="summary-number">${totalTime.toLocaleString()}</div>
                    <div class="summary-label">ì´ ì‘ì—…ì‹œê°„</div>
                </div>
                <div class="summary-card">
                    <div class="summary-number">${specSet.size}</div>
                    <div class="summary-label">ìƒì‚° ê·œê²© ìˆ˜ëŸ‰</div>
                </div>
                <div class="summary-card">
                    <div class="summary-number">${avgUPH}</div>
                    <div class="summary-label">í‰ê·  UPH</div>
                </div>
            `;
        }

        // 3) ì„¤ë¹„ ë¶„ì„
        function generateEquipmentAnalysis(headers) {
            const equipmentColumn = findColumn(headers, ['ì„¤ë¹„', 'equipment', 'machine']);
            const productionColumn = findColumn(headers, ['ìƒì‚°ìˆ˜ëŸ‰', 'production', 'quantity']);
            const efficiencyColumn = findColumn(headers, ['íš¨ìœ¨', 'efficiency']);
            const defectColumn = findColumn(headers, ['ë¶ˆëŸ‰', 'defect']);
            
            if (!equipmentColumn) {
                document.getElementById('equipmentAnalysis').innerHTML = '<p style="text-align: center; color: #4a5568;">ì„¤ë¹„ ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>';
                return;
            }
            
            const equipmentStats = {};
            
            excelData.forEach(row => {
                const equipment = row[equipmentColumn];
                const production = parseFloat(row[productionColumn]) || 0;
                const efficiency = parseFloat(row[efficiencyColumn]) || 0;
                const defect = parseFloat(row[defectColumn]) || 0;
                
                if (equipment && equipment !== '0') {
                    if (!equipmentStats[equipment]) {
                        equipmentStats[equipment] = {
                            totalProduction: 0,
                            totalEfficiency: 0,
                            totalDefect: 0,
                            count: 0
                        };
                    }
                    equipmentStats[equipment].totalProduction += production;
                    equipmentStats[equipment].totalEfficiency += efficiency;
                    equipmentStats[equipment].totalDefect += defect;
                    equipmentStats[equipment].count += 1;
                }
            });
            
            if (Object.keys(equipmentStats).length === 0) {
                document.getElementById('equipmentAnalysis').innerHTML = '<p style="text-align: center; color: #4a5568;">ì„¤ë¹„ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
                return;
            }
            
            let equipmentHTML = `
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>ì„¤ë¹„ëª…</th>
                            <th>ìƒì‚°ìˆ˜ëŸ‰</th>
                            <th>ê°€ë™ìœ¨</th>
                            <th>í‰ê· íš¨ìœ¨(%)</th>
                            <th>ë¶ˆëŸ‰ìœ¨(%)</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            Object.entries(equipmentStats).forEach(([equipment, stats]) => {
                const avgEfficiency = stats.count > 0 ? (stats.totalEfficiency / stats.count).toFixed(1) : 0;
                const defectRate = stats.totalProduction > 0 ? ((stats.totalDefect / stats.totalProduction) * 100).toFixed(2) : 0;
                const operationRate = ((stats.count / excelData.length) * 100).toFixed(1);
                
                equipmentHTML += `
                    <tr>
                        <td>${equipment}</td>
                        <td>${stats.totalProduction.toLocaleString()}</td>
                        <td>${operationRate}%</td>
                        <td>${avgEfficiency}%</td>
                        <td>${defectRate}%</td>
                    </tr>
                `;
            });
            
            equipmentHTML += '</tbody></table>';
            document.getElementById('equipmentAnalysis').innerHTML = equipmentHTML;
        }

        // 4) ì œí’ˆ ê·œê²©ë³„ ë¶„ì„
        function generateProductAnalysis(headers) {
            const specColumn = findColumn(headers, ['ê·œê²©', 'spec', 'model']);
            const productionColumn = findColumn(headers, ['ìƒì‚°ìˆ˜ëŸ‰', 'production', 'quantity']);
            const ctColumn = findColumn(headers, ['CT', 'C/T', 'cycletime']);
            const efficiency2Column = findColumn(headers, ['íš¨ìœ¨2', 'efficiency2']);
            const defectColumn = findColumn(headers, ['ë¶ˆëŸ‰', 'defect']);
            const equipmentColumn = findColumn(headers, ['ì„¤ë¹„', 'equipment', 'machine']);
            
            if (!specColumn) {
                document.getElementById('productAnalysis').innerHTML = '<p style="text-align: center; color: #4a5568;">ê·œê²© ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>';
                return;
            }
            
            const specStats = {};
            
            excelData.forEach(row => {
                const spec = row[specColumn];
                const production = parseFloat(row[productionColumn]) || 0;
                const ct = parseFloat(row[ctColumn]) || 0;
                const efficiency2 = parseFloat(row[efficiency2Column]) || 0;
                const defect = parseFloat(row[defectColumn]) || 0;
                const equipment = row[equipmentColumn];
                
                if (spec && spec !== '0') {
                    if (!specStats[spec]) {
                        specStats[spec] = {
                            totalProduction: 0,
                            totalCT: 0,
                            totalEfficiency2: 0,
                            totalDefect: 0,
                            count: 0,
                            equipment: new Set()
                        };
                    }
                    specStats[spec].totalProduction += production;
                    specStats[spec].totalCT += ct;
                    specStats[spec].totalEfficiency2 += efficiency2;
                    specStats[spec].totalDefect += defect;
                    specStats[spec].count += 1;
                    if (equipment && equipment !== '0') specStats[spec].equipment.add(equipment);
                }
            });
            
            if (Object.keys(specStats).length === 0) {
                document.getElementById('productAnalysis').innerHTML = '<p style="text-align: center; color: #4a5568;">ê·œê²© ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
                return;
            }
            
            let productHTML = `
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>ê·œê²©</th>
                            <th>ìƒì‚°ìˆ˜ëŸ‰</th>
                            <th>í‰ê·  UPH</th>
                            <th>í‰ê·  C/T</th>
                            <th>í‰ê·  íš¨ìœ¨2(%)</th>
                            <th>ë¶ˆëŸ‰ìœ¨(%)</th>
                            <th>ì ìš©ì„¤ë¹„</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            Object.entries(specStats).forEach(([spec, stats]) => {
                const avgUPH = stats.count > 0 ? (stats.totalProduction / stats.count).toFixed(2) : 0;
                const avgCT = stats.count > 0 ? (stats.totalCT / stats.count).toFixed(2) : 0;
                const avgEfficiency2 = stats.count > 0 ? (stats.totalEfficiency2 / stats.count).toFixed(1) : 0;
                const defectRate = stats.totalProduction > 0 ? ((stats.totalDefect / stats.totalProduction) * 100).toFixed(2) : 0;
                const equipmentList = Array.from(stats.equipment).join(', ') || 'N/A';
                
                productHTML += `
                    <tr>
                        <td>${spec}</td>
                        <td>${stats.totalProduction.toLocaleString()}</td>
                        <td>${avgUPH}</td>
                        <td>${avgCT}ì´ˆ</td>
                        <td>${avgEfficiency2}%</td>
                        <td>${defectRate}%</td>
                        <td>${equipmentList}</td>
                    </tr>
                `;
            });
            
            productHTML += '</tbody></table>';
            document.getElementById('productAnalysis').innerHTML = productHTML;
        }

        // PDF ë‚´ë³´ë‚´ê¸°
        function exportToPDF() {
            const element = document.getElementById('result-container');
            const opt = {
                margin: 1,
                filename: `V_SPOOL_ë¶„ì„ë³´ê³ ì„œ_${fileName.replace(/\.[^/.]+$/, "")}_${new Date().toISOString().slice(0, 10)}.pdf`,
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2 },
                jsPDF: { unit: 'in', format: 'a4', orientation: 'portrait' }
            };
            
            html2pdf().set(opt).from(element).save();
        }
    </script>
</body>
</html>
