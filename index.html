<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>엑셀 데이터 분석 - 생산수량 합계</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            text-align: center;
        }
        .result-box {
            background: #e8f5e8;
            border: 2px solid #4CAF50;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            text-align: center;
        }
        .process-item {
            background: #f9f9f9;
            border: 1px solid #ddd;
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .process-name {
            font-weight: bold;
            color: #333;
        }
        .process-quantity {
            font-size: 18px;
            font-weight: bold;
            color: #2e7d32;
        }
        .detail-btn {
            background-color: #2196F3;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        .stat-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        .stat-card {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 6px;
            padding: 15px;
            text-align: center;
        }
        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #2e7d32;
        }
        .stat-label {
            font-size: 14px;
            color: #666;
            margin-top: 5px;
        }
        .total-sum {
            font-size: 24px;
            font-weight: bold;
            color: #2e7d32;
        }
        .data-info {
            background: #f0f0f0;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        th {
            background-color: #f2f2f2;
            font-weight: bold;
        }
        tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        .btn {
            background-color: #4CAF50;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
        }
        .btn:hover {
            background-color: #45a049;
        }
        .btn:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        #loading-indicator {
            background-color: #e3f2fd;
            border: 1px solid #2196F3;
            padding: 15px;
            border-radius: 5px;
            color: #1976d2;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>엑셀 데이터 분석 - 공정명별 생산수량 합계</h1>
        
        <div id="loading-indicator" style="display: none; text-align: center; margin: 20px;">
            <p>📊 엑셀 파일을 로딩 중입니다...</p>
        </div>
        
        <input type="file" id="fileInput" accept=".xlsx,.xls" style="display: none;">
        <button id="loadBtn" class="btn">엑셀 파일 선택하기</button>
        
        <div id="result-container" style="display: none;">
            <div class="result-box">
                <h2>공정명별 생산수량 합계</h2>
                <div id="process-results"></div>
            </div>
            
            <div id="data-info" class="data-info">
                <p><strong>데이터 정보:</strong></p>
                <div id="info-details"></div>
            </div>
        </div>
    </div>

    <script>
        let excelData = [];
        
        document.getElementById('loadBtn').addEventListener('click', () => {
            document.getElementById('fileInput').click();
        });
        
        document.getElementById('fileInput').addEventListener('change', handleFileSelect);
        
        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            loadExcelFile(file);
        }
        
        async function loadExcelFile(file) {
            const loadBtn = document.getElementById('loadBtn');
            const loadingIndicator = document.getElementById('loading-indicator');
            
            try {
                // 로딩 상태 표시
                loadBtn.disabled = true;
                loadBtn.textContent = '로딩 중...';
                loadingIndicator.style.display = 'block';
                
                const arrayBuffer = await file.arrayBuffer();
                const workbook = XLSX.read(arrayBuffer, { type: 'array' });
                
                // 첫 번째 시트 읽기
                const firstSheetName = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[firstSheetName];
                
                // JSON으로 변환 (첫 행을 헤더로 사용)
                excelData = XLSX.utils.sheet_to_json(worksheet);
                
                console.log('로드된 데이터:', excelData);
                console.log('시트 이름들:', workbook.SheetNames);
                
                // 데이터 분석 및 표시
                analyzeData();
                
            } catch (error) {
                alert('파일 로드 중 오류가 발생했습니다: ' + error.message);
                console.error('상세 오류 정보:', error);
            } finally {
                // 로딩 상태 해제
                loadBtn.disabled = false;
                loadBtn.textContent = '엑셀 파일 선택하기';
                loadingIndicator.style.display = 'none';
            }
        }
        
        function generateProcessDetailHTML(processName, analysis, processNumber = null) {
            try {
                if (!analysis) {
                    return `
                        <div class="process-detail" style="margin: 20px 0; padding: 20px; background: #f8f9fa; border-radius: 8px; border-left: 4px solid #dc3545;">
                            <h3 style="color: #dc3545; margin-bottom: 20px;">${processName} - 분석 데이터 없음</h3>
                            <p style="color: #666;">분석할 데이터가 없습니다.</p>
                        </div>
                    `;
                }

                const displayTitle = processNumber ? 
                    `${processName} (${processNumber}) 공정 상세 분석` : 
                    `${processName} 공정 상세 분석`;
                    
                let contentHTML = `
                    <div class="process-detail" style="margin: 50px 0; padding: 50px; background: linear-gradient(135deg, #f7fafc 0%, #edf2f7 100%); border-radius: 20px; border: 3px solid #4299e1; box-shadow: 0 20px 60px rgba(66, 153, 225, 0.15); position: relative;">
                        <div style="position: absolute; top: 0; left: 0; right: 0; height: 8px; background: linear-gradient(90deg, #4299e1 0%, #38b2ac 25%, #68d391 50%, #f6e05e 75%, #fc8181 100%); border-radius: 20px 20px 0 0;"></div>
                        <h1 style="color: #2d3748; margin-bottom: 40px; font-size: 36px; font-weight: 800; text-align: center; text-shadow: 2px 2px 4px rgba(0,0,0,0.1);">${displayTitle}</h1>
                `;
                
                // 1) 생산 현황 종합 (6-1)
                if (analysis.productionSummary) {
                    const summary = analysis.productionSummary;
                    contentHTML += `
                        <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 40px; border-radius: 16px; margin-bottom: 50px; box-shadow: 0 15px 35px rgba(102, 126, 234, 0.2);">
                            <h2 style="color: white; margin-bottom: 30px; font-size: 28px; font-weight: 700; text-align: center; text-shadow: 2px 2px 4px rgba(0,0,0,0.3);">📊 1) 생산 현황 종합</h2>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 25px;">
                                <div style="background: rgba(255,255,255,0.95); padding: 30px; border-radius: 12px; text-align: center; box-shadow: 0 8px 25px rgba(0,0,0,0.1); backdrop-filter: blur(10px);">
                                    <div style="font-size: 42px; font-weight: 900; color: #4299e1; margin-bottom: 12px; text-shadow: 1px 1px 3px rgba(0,0,0,0.1);">${(summary.totalProduction || 0).toLocaleString()}</div>
                                    <div style="font-size: 18px; color: #4a5568; font-weight: 600;">총 생산수량</div>
                                </div>
                                <div style="background: rgba(255,255,255,0.95); padding: 30px; border-radius: 12px; text-align: center; box-shadow: 0 8px 25px rgba(0,0,0,0.1); backdrop-filter: blur(10px);">
                                    <div style="font-size: 42px; font-weight: 900; color: #38b2ac; margin-bottom: 12px; text-shadow: 1px 1px 3px rgba(0,0,0,0.1);">${summary.equipmentCount || 0}</div>
                                    <div style="font-size: 18px; color: #4a5568; font-weight: 600;">투입설비 대수</div>
                                </div>
                                <div style="background: rgba(255,255,255,0.95); padding: 30px; border-radius: 12px; text-align: center; box-shadow: 0 8px 25px rgba(0,0,0,0.1); backdrop-filter: blur(10px);">
                                    <div style="font-size: 42px; font-weight: 900; color: #68d391; margin-bottom: 12px; text-shadow: 1px 1px 3px rgba(0,0,0,0.1);">${summary.workerCount || 0}</div>
                                    <div style="font-size: 18px; color: #4a5568; font-weight: 600;">투입인원 수</div>
                                </div>
                                <div style="background: rgba(255,255,255,0.95); padding: 30px; border-radius: 12px; text-align: center; box-shadow: 0 8px 25px rgba(0,0,0,0.1); backdrop-filter: blur(10px);">
                                    <div style="font-size: 42px; font-weight: 900; color: #f6e05e; margin-bottom: 12px; text-shadow: 1px 1px 3px rgba(0,0,0,0.1);">${(summary.totalWorkTime || 0).toLocaleString()}</div>
                                    <div style="font-size: 18px; color: #4a5568; font-weight: 600;">총 작업시간</div>
                                </div>
                                <div style="background: rgba(255,255,255,0.95); padding: 30px; border-radius: 12px; text-align: center; box-shadow: 0 8px 25px rgba(0,0,0,0.1); backdrop-filter: blur(10px);">
                                    <div style="font-size: 42px; font-weight: 900; color: #fc8181; margin-bottom: 12px; text-shadow: 1px 1px 3px rgba(0,0,0,0.1);">${summary.avgUPH || 'N/A'}</div>
                                    <div style="font-size: 18px; color: #4a5568; font-weight: 600;">평균 UPH</div>
                                </div>
                            </div>
                        </div>
                    `;
                }
                
                // 2) 전체 '설비' 별 분석 (생산수량/평균효율/불량율/필요인원수)
                if (analysis.equipmentAnalysis && Object.keys(analysis.equipmentAnalysis).length > 0) {
                    contentHTML += `
                        <div style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); padding: 40px; border-radius: 16px; margin-bottom: 50px; box-shadow: 0 15px 35px rgba(240, 147, 251, 0.25);">
                            <h2 style="color: white; margin-bottom: 30px; font-size: 28px; font-weight: 700; text-align: center; text-shadow: 2px 2px 4px rgba(0,0,0,0.3);">🔧 2) 전체 '설비' 별 생산성 분석</h2>
                            <div style="background: rgba(255,255,255,0.95); border-radius: 12px; overflow: hidden; box-shadow: 0 10px 30px rgba(0,0,0,0.2); backdrop-filter: blur(10px);">
                                <div style="overflow-x: auto;">
                                    <table style="width: 100%; border-collapse: collapse; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;">
                                        <thead>
                                            <tr style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                                                <th style="padding: 20px; color: white; font-size: 18px; font-weight: 700; text-align: center; border: none;">설비명</th>
                                                <th style="padding: 20px; color: white; font-size: 18px; font-weight: 700; text-align: center; border: none;">생산수량</th>
                                                <th style="padding: 20px; color: white; font-size: 18px; font-weight: 700; text-align: center; border: none;">평균효율(%)</th>
                                                <th style="padding: 20px; color: white; font-size: 18px; font-weight: 700; text-align: center; border: none;">불량율(%)</th>
                                                <th style="padding: 20px; color: white; font-size: 18px; font-weight: 700; text-align: center; border: none;">필요인원수</th>
                                            </tr>
                                        </thead>
                                        <tbody>`;
                    
                    Object.entries(analysis.equipmentAnalysis).forEach(([equipment, stats], index) => {
                        const bgColor = index % 2 === 0 ? 'rgba(247, 250, 252, 0.8)' : 'rgba(237, 242, 247, 0.8)';
                        contentHTML += `
                            <tr style="background: ${bgColor}; transition: all 0.3s ease;" onmouseover="this.style.background='rgba(66, 153, 225, 0.1)'" onmouseout="this.style.background='${bgColor}'">
                                <td style="padding: 18px; font-size: 16px; font-weight: 600; color: #2d3748; border: none;">${equipment}</td>
                                <td style="padding: 18px; font-size: 16px; font-weight: 700; color: #4299e1; text-align: center; border: none;">${(stats.totalProduction || 0).toLocaleString()}</td>
                                <td style="padding: 18px; font-size: 16px; font-weight: 600; color: #38b2ac; text-align: center; border: none;">${stats.operationRate || 0}%</td>
                                <td style="padding: 18px; font-size: 16px; font-weight: 600; color: #fc8181; text-align: center; border: none;">${stats.defectRate || 0}%</td>
                                <td style="padding: 18px; font-size: 16px; font-weight: 600; color: #68d391; text-align: center; border: none;">${stats.requiredWorkers || 0.5}명/대</td>
                            </tr>`;
                    });
                    contentHTML += `</tbody></table></div></div></div>`;
                }
                
                // 3) 전체 '작업자' 별 분석 (생산수량/평균 UPH/불량율/인당 설비 운영 수)
                if (analysis.workerAnalysis && Object.keys(analysis.workerAnalysis).length > 0) {
                    contentHTML += `
                        <div style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); padding: 40px; border-radius: 16px; margin-bottom: 50px; box-shadow: 0 15px 35px rgba(79, 172, 254, 0.25);">
                            <h2 style="color: white; margin-bottom: 30px; font-size: 28px; font-weight: 700; text-align: center; text-shadow: 2px 2px 4px rgba(0,0,0,0.3);">👨‍🔧 3) 전체 '작업자' 별 생산성 분석</h2>
                            <div style="background: rgba(255,255,255,0.95); border-radius: 12px; overflow: hidden; box-shadow: 0 10px 30px rgba(0,0,0,0.2); backdrop-filter: blur(10px);">
                                <div style="overflow-x: auto;">
                                    <table style="width: 100%; border-collapse: collapse; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;">
                                        <thead>
                                            <tr style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);">
                                                <th style="padding: 20px; color: white; font-size: 18px; font-weight: 700; text-align: center; border: none;">작업자</th>
                                                <th style="padding: 20px; color: white; font-size: 18px; font-weight: 700; text-align: center; border: none;">생산수량</th>
                                                <th style="padding: 20px; color: white; font-size: 18px; font-weight: 700; text-align: center; border: none;">평균 UPH</th>
                                                <th style="padding: 20px; color: white; font-size: 18px; font-weight: 700; text-align: center; border: none;">불량율(%)</th>
                                                <th style="padding: 20px; color: white; font-size: 18px; font-weight: 700; text-align: center; border: none;">인당 설비 운영 수</th>
                                            </tr>
                                        </thead>
                                        <tbody>`;
                    
                    Object.entries(analysis.workerAnalysis).forEach(([worker, stats], index) => {
                        const bgColor = index % 2 === 0 ? 'rgba(247, 250, 252, 0.8)' : 'rgba(237, 242, 247, 0.8)';
                        contentHTML += `
                            <tr style="background: ${bgColor}; transition: all 0.3s ease;" onmouseover="this.style.background='rgba(79, 172, 254, 0.1)'" onmouseout="this.style.background='${bgColor}'">
                                <td style="padding: 18px; font-size: 16px; font-weight: 600; color: #2d3748; border: none;">${worker}</td>
                                <td style="padding: 18px; font-size: 16px; font-weight: 700; color: #4299e1; text-align: center; border: none;">${(stats.totalProduction || 0).toLocaleString()}</td>
                                <td style="padding: 18px; font-size: 16px; font-weight: 600; color: #38b2ac; text-align: center; border: none;">${stats.avgUPH || 'N/A'}</td>
                                <td style="padding: 18px; font-size: 16px; font-weight: 600; color: #fc8181; text-align: center; border: none;">${stats.defectRate || 0}%</td>
                                <td style="padding: 18px; font-size: 16px; font-weight: 600; color: #68d391; text-align: center; border: none;">${stats.equipmentCount || 0}대</td>
                            </tr>`;
                    });
                    contentHTML += `</tbody></table></div></div></div>`;
                }
                
                // 4) 시간대별 분석 (생산수량/UPH/불량율)
                if (analysis.hourlyAnalysis && Object.keys(analysis.hourlyAnalysis).length > 0) {
                    contentHTML += `
                        <div style="background: linear-gradient(135deg, #fa709a 0%, #fee140 100%); padding: 40px; border-radius: 16px; margin-bottom: 50px; box-shadow: 0 15px 35px rgba(250, 112, 154, 0.25);">
                            <h2 style="color: white; margin-bottom: 30px; font-size: 28px; font-weight: 700; text-align: center; text-shadow: 2px 2px 4px rgba(0,0,0,0.3);">🕐 4) 시간대별 생산성 분석</h2>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 25px;">`;
                    
                    Object.entries(analysis.hourlyAnalysis).sort(([a], [b]) => parseInt(a) - parseInt(b)).forEach(([hour, stats]) => {
                        contentHTML += `
                            <div style="background: rgba(255,255,255,0.95); padding: 30px; border-radius: 16px; text-align: center; box-shadow: 0 8px 25px rgba(0,0,0,0.15); backdrop-filter: blur(10px); transition: transform 0.3s ease;" onmouseover="this.style.transform='translateY(-5px)'" onmouseout="this.style.transform='translateY(0)'">
                                <div style="font-size: 48px; font-weight: 900; color: #fa709a; margin-bottom: 15px; text-shadow: 1px 1px 3px rgba(0,0,0,0.1);">${hour}시</div>
                                <div style="font-size: 16px; color: #4a5568; line-height: 2.2; font-weight: 600;">
                                    <div style="margin-bottom: 8px;">생산수량: <span style="color: #4299e1; font-weight: 700; font-size: 18px;">${(stats.totalProduction || 0).toLocaleString()}</span></div>
                                    <div style="margin-bottom: 8px;">UPH: <span style="color: #38b2ac; font-weight: 700; font-size: 18px;">${stats.uph || 'N/A'}</span></div>
                                    <div>불량율: <span style="color: #fc8181; font-weight: 700; font-size: 18px;">${stats.defectRate || 0}%</span></div>
                                </div>
                            </div>
                        `;
                    });
                    contentHTML += `</div></div>`;
                }
                
                // 5) 근무시간별 분석: 오전(주간)조/오후(야간)조/3교대 야간조
                if (analysis.shiftAnalysis && Object.keys(analysis.shiftAnalysis).length > 0) {
                    contentHTML += `
                        <div style="background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%); padding: 40px; border-radius: 16px; margin-bottom: 50px; box-shadow: 0 15px 35px rgba(168, 237, 234, 0.25);">
                            <h2 style="color: #2d3748; margin-bottom: 30px; font-size: 28px; font-weight: 700; text-align: center; text-shadow: 1px 1px 3px rgba(255,255,255,0.8);">⏰ 5) 3개조별 생산성 분석</h2>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 30px;">`;
                    
                    Object.entries(analysis.shiftAnalysis).forEach(([shift, stats]) => {
                        let shiftIcon = '🌅';
                        let shiftColor = '#4299e1';
                        if (shift.includes('야간') || shift.includes('밤')) {
                            shiftIcon = '🌙';
                            shiftColor = '#805ad5';
                        } else if (shift.includes('오후') || shift.includes('저녁')) {
                            shiftIcon = '🌆';
                            shiftColor = '#f6ad55';
                        }
                        
                        contentHTML += `
                            <div style="background: rgba(255,255,255,0.95); padding: 35px; border-radius: 16px; text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.15); backdrop-filter: blur(10px); border: 3px solid ${shiftColor}; transition: transform 0.3s ease;" onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
                                <div style="font-size: 48px; margin-bottom: 15px;">${shiftIcon}</div>
                                <div style="font-size: 46px; font-weight: 900; color: ${shiftColor}; margin-bottom: 15px; text-shadow: 1px 1px 3px rgba(0,0,0,0.1);">${(stats.totalProduction || 0).toLocaleString()}</div>
                                <div style="font-size: 22px; color: #2d3748; margin-bottom: 15px; font-weight: 700;">${shift}</div>
                                <div style="font-size: 18px; color: #4a5568; font-weight: 600;">생산성: <span style="color: ${shiftColor}; font-weight: 700;">${stats.productivity || 'N/A'}</span></div>
                            </div>
                        `;
                    });
                    contentHTML += `</div></div>`;
                }
                
                // 6) '규격' 별 총 생산 실적 및 적용 설비 (6-1)
                if (analysis.specAnalysis && Object.keys(analysis.specAnalysis).length > 0) {
                    contentHTML += `
                        <div style="background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%); padding: 40px; border-radius: 16px; margin-bottom: 50px; box-shadow: 0 15px 35px rgba(255, 154, 158, 0.25);">
                            <h2 style="color: white; margin-bottom: 30px; font-size: 28px; font-weight: 700; text-align: center; text-shadow: 2px 2px 4px rgba(0,0,0,0.3);">📏 6) '규격' 별 총 생산 실적 및 적용 설비</h2>
                            <div style="background: rgba(255,255,255,0.95); border-radius: 12px; overflow: hidden; box-shadow: 0 10px 30px rgba(0,0,0,0.2); backdrop-filter: blur(10px);">
                                <div style="overflow-x: auto;">
                                    <table style="width: 100%; border-collapse: collapse; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;">
                                        <thead>
                                            <tr style="background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%);">
                                                <th style="padding: 20px; color: white; font-size: 18px; font-weight: 700; text-align: center; border: none;">규격</th>
                                                <th style="padding: 20px; color: white; font-size: 18px; font-weight: 700; text-align: center; border: none;">생산수량</th>
                                                <th style="padding: 20px; color: white; font-size: 18px; font-weight: 700; text-align: center; border: none;">평균 UPH</th>
                                                <th style="padding: 20px; color: white; font-size: 18px; font-weight: 700; text-align: center; border: none;">적용 C/T</th>
                                                <th style="padding: 20px; color: white; font-size: 18px; font-weight: 700; text-align: center; border: none;">효율2(%)</th>
                                                <th style="padding: 20px; color: white; font-size: 18px; font-weight: 700; text-align: center; border: none;">불량율(%)</th>
                                                <th style="padding: 20px; color: white; font-size: 18px; font-weight: 700; text-align: center; border: none;">적용설비</th>
                                            </tr>
                                        </thead>
                                        <tbody>`;
                    
                    Object.entries(analysis.specAnalysis).forEach(([spec, stats], index) => {
                        const bgColor = index % 2 === 0 ? 'rgba(247, 250, 252, 0.8)' : 'rgba(237, 242, 247, 0.8)';
                        contentHTML += `
                            <tr style="background: ${bgColor}; transition: all 0.3s ease;" onmouseover="this.style.background='rgba(255, 154, 158, 0.1)'" onmouseout="this.style.background='${bgColor}'">
                                <td style="padding: 18px; font-size: 16px; font-weight: 600; color: #2d3748; border: none;">${spec}</td>
                                <td style="padding: 18px; font-size: 16px; font-weight: 700; color: #4299e1; text-align: center; border: none;">${(stats.totalProduction || 0).toLocaleString()}</td>
                                <td style="padding: 18px; font-size: 16px; font-weight: 600; color: #38b2ac; text-align: center; border: none;">${stats.avgUPH || 'N/A'}</td>
                                <td style="padding: 18px; font-size: 16px; font-weight: 600; color: #f6ad55; text-align: center; border: none;">${stats.avgCT || 'N/A'}초</td>
                                <td style="padding: 18px; font-size: 16px; font-weight: 600; color: #68d391; text-align: center; border: none;">${stats.efficiency || 0}%</td>
                                <td style="padding: 18px; font-size: 16px; font-weight: 600; color: #fc8181; text-align: center; border: none;">${stats.defectRate || 0}%</td>
                                <td style="padding: 18px; font-size: 16px; font-weight: 600; color: #805ad5; border: none;">${(stats.equipmentList || []).join(', ')}</td>
                            </tr>`;
                    });
                    contentHTML += `</tbody></table></div></div></div>`;
                }
                
                // 7) '작업자'별 '설비' 운영 실적 (7-1)
                if (analysis.workerEquipmentAnalysis && Object.keys(analysis.workerEquipmentAnalysis).length > 0) {
                    contentHTML += `
                        <div style="background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%); padding: 40px; border-radius: 16px; margin-bottom: 50px; box-shadow: 0 15px 35px rgba(252, 182, 159, 0.25);">
                            <h2 style="color: #2d3748; margin-bottom: 30px; font-size: 28px; font-weight: 700; text-align: center; text-shadow: 1px 1px 3px rgba(255,255,255,0.8);">🔧👨‍🔧 7) '작업자'별 '설비' 운영 실적</h2>
                            <div style="background: rgba(255,255,255,0.95); border-radius: 12px; overflow: hidden; box-shadow: 0 10px 30px rgba(0,0,0,0.2); backdrop-filter: blur(10px);">
                                <div style="overflow-x: auto;">
                                    <table style="width: 100%; border-collapse: collapse; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;">
                                        <thead>
                                            <tr style="background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);">
                                                <th style="padding: 20px; color: #2d3748; font-size: 18px; font-weight: 700; text-align: center; border: none; text-shadow: 1px 1px 2px rgba(255,255,255,0.8);">작업자</th>
                                                <th style="padding: 20px; color: #2d3748; font-size: 18px; font-weight: 700; text-align: center; border: none; text-shadow: 1px 1px 2px rgba(255,255,255,0.8);">설비운영 대수</th>
                                                <th style="padding: 20px; color: #2d3748; font-size: 18px; font-weight: 700; text-align: center; border: none; text-shadow: 1px 1px 2px rgba(255,255,255,0.8);">운영설비별 생산실적</th>
                                            </tr>
                                        </thead>
                                        <tbody>`;
                    
                    Object.entries(analysis.workerEquipmentAnalysis).forEach(([worker, stats], index) => {
                        const bgColor = index % 2 === 0 ? 'rgba(247, 250, 252, 0.8)' : 'rgba(237, 242, 247, 0.8)';
                        const equipmentDetails = Object.entries(stats.equipmentDetails || {})
                            .map(([eq, data]) => `<span style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 8px 12px; border-radius: 20px; font-weight: 600; margin: 2px; display: inline-block; box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);">${eq}(${(data.totalProduction || 0).toLocaleString()})</span>`)
                            .join(' ');
                        
                        contentHTML += `
                            <tr style="background: ${bgColor}; transition: all 0.3s ease;" onmouseover="this.style.background='rgba(252, 182, 159, 0.1)'" onmouseout="this.style.background='${bgColor}'">
                                <td style="padding: 18px; font-size: 16px; font-weight: 600; color: #2d3748; border: none;">${worker}</td>
                                <td style="padding: 18px; font-size: 16px; font-weight: 700; color: #4299e1; text-align: center; border: none;">${stats.equipmentCount || 0}대</td>
                                <td style="padding: 18px; font-size: 14px; border: none; line-height: 1.8;">${equipmentDetails || '<span style="color: #718096; font-style: italic;">N/A</span>'}</td>
                            </tr>`;
                    });
                    contentHTML += `</tbody></table></div></div></div>`;
                }
                
                // 종합 인사이트만 간단히 표시
                try {
                    if (typeof generateComprehensiveInsights === 'function') {
                        const insights = generateComprehensiveInsights(analysis);
                        if (insights) {
                            contentHTML += `
                                <h4 style="color: #333; margin: 15px 0 10px 0;">� 종합 분석 인사이트</h4>
                                <div style="background: #e8f5e8; padding: 15px; border-radius: 6px; margin: 10px 0; font-size: 13px;">
                                    ${insights}
                                </div>
                            `;
                        }
                    }
                } catch (insightError) {
                    console.warn('인사이트 생성 중 오류:', insightError);
                }
                
                contentHTML += `</div>`;
                return contentHTML;
                
            } catch (error) {
                console.error('상세 분석 생성 중 오류:', error);
                return `
                    <div class="process-detail" style="margin: 40px 0; padding: 40px; background: #f8f9fa; border-radius: 12px; border-left: 6px solid #dc3545;">
                        <h2 style="color: #dc3545; margin-bottom: 20px; font-size: 24px;">${processName || '알 수 없음'} 공정 분석 오류</h2>
                        <p style="color: #666; font-size: 16px;">상세 분석 중 오류가 발생했습니다: ${error.message}</p>
                    </div>
                `;
            }
        }

        function createProcessMapping(data, processColumn, itemColumn) {
            const mapping = {};
            
            if (!itemColumn) {
                console.warn('품목 컬럼을 찾을 수 없어 공정번호를 추출할 수 없습니다.');
                return mapping;
            }
            
            data.forEach(row => {
                const processName = row[processColumn];
                const itemCode = row[itemColumn];
                
                if (processName && itemCode) {
                    // 품목 코드에서 마지막 3자리 추출
                    const processNumber = extractProcessNumber(itemCode);
                    if (processNumber && !mapping[processName]) {
                        mapping[processName] = processNumber;
                    }
                }
            });
            
            return mapping;
        }
        
        function extractProcessNumber(itemCode) {
            if (!itemCode) return null;
            
            // 문자열로 변환하고 숫자만 추출
            const codeStr = itemCode.toString();
            const numbers = codeStr.replace(/[^\d]/g, ''); // 숫자가 아닌 문자 제거
            
            if (numbers.length >= 3) {
                return numbers.slice(-3); // 마지막 3자리
            }
            
            return null;
        }

        function analyzeData() {
            if (excelData.length === 0) {
                alert('데이터가 없습니다.');
                return;
            }
            
            const headers = Object.keys(excelData[0]);
            console.log('헤더:', headers);
            
            // 공정명 컬럼 찾기
            const processColumn = headers.find(header => 
                header.includes('공정명') || 
                header === '공정명' ||
                header.toLowerCase().includes('process')
            );
            
            // 품목 컬럼 찾기 (공정번호 추출용)
            const itemColumn = headers.find(header => 
                header.includes('품목') || 
                header === '품목' ||
                header.toLowerCase().includes('item') ||
                header.toLowerCase().includes('product')
            );
            
            // 생산수량 컬럼 찾기
            const productionColumn = headers.find(header => 
                header.includes('생산수량') || 
                header === '생산수량' ||
                header.toLowerCase().includes('production') ||
                header.toLowerCase().includes('quantity')
            );
            
            if (!processColumn) {
                alert(`공정명 컬럼을 찾을 수 없습니다.\n사용 가능한 컬럼: ${headers.join(', ')}`);
                console.log('사용 가능한 컬럼들:', headers);
                return;
            }
            
            if (!productionColumn) {
                alert(`생산수량 컬럼을 찾을 수 없습니다.\n사용 가능한 컬럼: ${headers.join(', ')}`);
                console.log('사용 가능한 컬럼들:', headers);
                return;
            }
            
            // 공정번호와 공정명 매핑 생성
            const processMapping = createProcessMapping(excelData, processColumn, itemColumn);
            
            // 공정명별 생산수량 집계
            const processResults = {};
            let totalValidRows = 0;
            let totalInvalidRows = 0;
            let grandTotal = 0;
            
            excelData.forEach((row, index) => {
                const processName = row[processColumn];
                const productionValue = row[productionColumn];
                
                if (processName && productionValue !== null && productionValue !== undefined && productionValue !== '') {
                    const numValue = parseFloat(productionValue);
                    if (!isNaN(numValue)) {
                        if (!processResults[processName]) {
                            processResults[processName] = {
                                total: 0,
                                count: 0,
                                processNumber: processMapping[processName] || '000'
                            };
                        }
                        processResults[processName].total += numValue;
                        processResults[processName].count += 1;
                        totalValidRows++;
                        grandTotal += numValue;
                    } else {
                        totalInvalidRows++;
                        console.warn(`행 ${index + 2}: 유효하지 않은 숫자 값 "${productionValue}"`);
                    }
                } else {
                    totalInvalidRows++;
                }
            });
            
            // 결과 표시
            displayProcessResults(processResults, processColumn, productionColumn, totalValidRows, totalInvalidRows, grandTotal, headers);
        }
        
        function displayProcessResults(processResults, processColumnName, productionColumnName, totalValidRows, totalInvalidRows, grandTotal, headers) {
            // 결과 컨테이너 표시
            document.getElementById('result-container').style.display = 'block';
            
            // 공정별 결과 표시
            const processResultsDiv = document.getElementById('process-results');
            let resultsHTML = '';
            
            // 공정명별 결과를 공정번호 순으로 정렬
            const sortedProcesses = Object.entries(processResults)
                .sort(([,a], [,b]) => {
                    const numA = parseInt(a.processNumber) || 999;
                    const numB = parseInt(b.processNumber) || 999;
                    return numA - numB;
                });
            
            sortedProcesses.forEach(([processName, data]) => {
                const percentage = ((data.total / grandTotal) * 100).toFixed(1);
                const displayName = data.processNumber ? 
                    `${processName} (${data.processNumber})` : 
                    processName;
                    
                resultsHTML += `
                    <div class="process-item">
                        <div class="process-name">${displayName}</div>
                        <div class="process-quantity">
                            ${data.total.toLocaleString()} (${percentage}%)
                            <br><small>${data.count}건</small>
                        </div>
                    </div>
                `;
                
                // 각 공정별 상세 분석 내용 추가
                const processData = excelData.filter(row => row[processColumnName] === processName);
                if (processData.length > 0) {
                    const analysis = analyzeProcessData(processData, processName, productionColumnName, headers);
                    const processNumber = data.processNumber;
                    resultsHTML += generateProcessDetailHTML(processName, analysis, processNumber);
                }
            });
            
            // 전체 합계 추가
            resultsHTML += `
                <div class="process-item" style="background: #e8f5e8; border: 2px solid #4CAF50; font-weight: bold;">
                    <div class="process-name">📊 전체 합계</div>
                    <div class="process-quantity" style="font-size: 20px;">
                        ${grandTotal.toLocaleString()}
                    </div>
                </div>
            `;
            
            processResultsDiv.innerHTML = resultsHTML;
            
            // 데이터 정보 표시
            const infoDetails = document.getElementById('info-details');
            infoDetails.innerHTML = `
                <p>• 전체 행 수: ${excelData.length.toLocaleString()}개</p>
                <p>• 유효한 데이터: ${totalValidRows.toLocaleString()}개</p>
                <p>• 무효한 데이터: ${totalInvalidRows.toLocaleString()}개</p>
                <p>• 공정명 컬럼: "${processColumnName}"</p>
                <p>• 생산수량 컬럼: "${productionColumnName}"</p>
                <p>• 공정 종류: ${Object.keys(processResults).length}개</p>
                <p>• 전체 생산수량: ${grandTotal.toLocaleString()}</p>
                <p>• 평균 생산수량: ${totalValidRows > 0 ? (grandTotal / totalValidRows).toFixed(2) : 0}</p>
            `;
        }

        function analyzeProcessData(processData, processName, productionColumn, headers) {
            const productions = processData
                .map(row => parseFloat(row[productionColumn]))
                .filter(val => !isNaN(val));
            
            const totalProduction = productions.reduce((sum, val) => sum + val, 0);
            const avgProduction = productions.length > 0 ? totalProduction / productions.length : 0;
            
            // 1) 생산 현황 종합 분석
            const productionSummary = analyzeProductionSummary(processData, headers, totalProduction);
            
            // 2) 설비별 분석
            const equipmentAnalysis = analyzeEquipmentData(processData, headers);
            
            // 3) 작업자별 분석
            const workerAnalysis = analyzeWorkerData(processData, headers);
            
            // 4) 시간대별 분석
            const hourlyAnalysis = analyzeHourlyData(processData, headers);
            
            // 5) 교대별 분석
            const shiftAnalysis = analyzeShiftData(processData, headers);
            
            // 6) 규격별 분석
            const specAnalysis = analyzeSpecData(processData, headers);
            
            // 7) 작업자별 설비 운영 실적
            const workerEquipmentAnalysis = analyzeWorkerEquipmentData(processData, headers);
            
            return {
                productionSummary,
                equipmentAnalysis,
                workerAnalysis,
                hourlyAnalysis,
                shiftAnalysis,
                specAnalysis,
                workerEquipmentAnalysis,
                rawData: processData.slice(0, 5) // 상위 5개 원본 데이터
            };
        }
        
        function calculateStandardDeviation(values) {
            const mean = values.reduce((sum, val) => sum + val, 0) / values.length;
            const squaredDiffs = values.map(val => Math.pow(val - mean, 2));
            const avgSquaredDiff = squaredDiffs.reduce((sum, val) => sum + val, 0) / values.length;
            return Math.sqrt(avgSquaredDiff);
        }
        
        // 1) 생산 현황 종합 분석
        function analyzeProductionSummary(processData, headers, totalProduction) {
            const equipmentColumn = findColumn(headers, ['설비', '장비', 'equipment', 'machine']);
            const workerColumn = findColumn(headers, ['작업자', '인원', 'worker', 'operator']);
            const timeColumn = findColumn(headers, ['작업시간', '운영시간', 'time', 'hour']);
            
            const equipmentCount = equipmentColumn ? getUniqueCount(processData, equipmentColumn) : 0;
            const workerCount = workerColumn ? getUniqueCount(processData, workerColumn) : 0;
            const totalWorkTime = timeColumn ? getSumValue(processData, timeColumn) : 0;
            const avgUPH = totalWorkTime > 0 ? (totalProduction / totalWorkTime).toFixed(2) : 0;
            
            return {
                totalProduction,
                equipmentCount,
                workerCount,
                totalWorkTime,
                avgUPH
            };
        }
        
        // 2) 설비별 분석
        function analyzeEquipmentData(processData, headers) {
            const equipmentColumn = findColumn(headers, ['설비', '장비', 'equipment', 'machine']);
            const productionColumn = findColumn(headers, ['생산수량', 'production', 'quantity']);
            const defectColumn = findColumn(headers, ['불량', '결함', 'defect', 'reject']);
            const workerColumn = findColumn(headers, ['작업자', '인원', 'worker', 'operator']);
            
            if (!equipmentColumn) return null;
            
            const equipmentStats = {};
            
            processData.forEach(row => {
                const equipment = row[equipmentColumn];
                const production = parseFloat(row[productionColumn]) || 0;
                const defect = parseFloat(row[defectColumn]) || 0;
                const worker = row[workerColumn];
                
                if (!equipmentStats[equipment]) {
                    equipmentStats[equipment] = {
                        totalProduction: 0,
                        totalDefect: 0,
                        workers: new Set(),
                        records: 0
                    };
                }
                
                equipmentStats[equipment].totalProduction += production;
                equipmentStats[equipment].totalDefect += defect;
                equipmentStats[equipment].records += 1;
                if (worker) equipmentStats[equipment].workers.add(worker);
            });
            
            // 각 설비별 지표 계산
            Object.keys(equipmentStats).forEach(equipment => {
                const stats = equipmentStats[equipment];
                stats.productivity = (stats.totalProduction / stats.records).toFixed(2);
                stats.operationRate = ((stats.records / processData.length) * 100).toFixed(1);
                stats.defectRate = stats.totalProduction > 0 ? ((stats.totalDefect / stats.totalProduction) * 100).toFixed(2) : 0;
                stats.requiredWorkers = stats.workers.size;
            });
            
            return equipmentStats;
        }
        
        // 3) 작업자별 분석
        function analyzeWorkerData(processData, headers) {
            const workerColumn = findColumn(headers, ['작업자', '인원', 'worker', 'operator']);
            const productionColumn = findColumn(headers, ['생산수량', 'production', 'quantity']);
            const defectColumn = findColumn(headers, ['불량', '결함', 'defect', 'reject']);
            const equipmentColumn = findColumn(headers, ['설비', '장비', 'equipment', 'machine']);
            
            if (!workerColumn) return null;
            
            const workerStats = {};
            
            processData.forEach(row => {
                const worker = row[workerColumn];
                const production = parseFloat(row[productionColumn]) || 0;
                const defect = parseFloat(row[defectColumn]) || 0;
                const equipment = row[equipmentColumn];
                
                if (!workerStats[worker]) {
                    workerStats[worker] = {
                        totalProduction: 0,
                        totalDefect: 0,
                        equipments: new Set(),
                        records: 0
                    };
                }
                
                workerStats[worker].totalProduction += production;
                workerStats[worker].totalDefect += defect;
                workerStats[worker].records += 1;
                if (equipment) workerStats[worker].equipments.add(equipment);
            });
            
            // 각 작업자별 지표 계산
            Object.keys(workerStats).forEach(worker => {
                const stats = workerStats[worker];
                stats.productivity = (stats.totalProduction / stats.records).toFixed(2);
                stats.defectRate = stats.totalProduction > 0 ? ((stats.totalDefect / stats.totalProduction) * 100).toFixed(2) : 0;
                stats.equipmentCount = stats.equipments.size;
            });
            
            return workerStats;
        }
        
        // 4) 시간대별 분석 (24시간)
        function analyzeHourlyData(processData, headers) {
            const timeColumn = findColumn(headers, ['시간', '작업시간', 'time', 'hour']);
            const productionColumn = findColumn(headers, ['생산수량', 'production', 'quantity']);
            const defectColumn = findColumn(headers, ['불량', '결함', 'defect', 'reject']);
            
            if (!timeColumn) return null;
            
            const hourlyStats = {};
            
            processData.forEach(row => {
                const timeValue = row[timeColumn];
                const hour = extractHour(timeValue);
                const production = parseFloat(row[productionColumn]) || 0;
                const defect = parseFloat(row[defectColumn]) || 0;
                
                if (hour !== null) {
                    if (!hourlyStats[hour]) {
                        hourlyStats[hour] = {
                            totalProduction: 0,
                            totalDefect: 0,
                            records: 0
                        };
                    }
                    
                    hourlyStats[hour].totalProduction += production;
                    hourlyStats[hour].totalDefect += defect;
                    hourlyStats[hour].records += 1;
                }
            });
            
            // 시간대별 지표 계산
            Object.keys(hourlyStats).forEach(hour => {
                const stats = hourlyStats[hour];
                stats.productivity = (stats.totalProduction / stats.records).toFixed(2);
                stats.uph = stats.totalProduction; // UPH = Unit Per Hour
                stats.defectRate = stats.totalProduction > 0 ? ((stats.totalDefect / stats.totalProduction) * 100).toFixed(2) : 0;
            });
            
            return hourlyStats;
        }
        
        // 5) 교대별 분석
        function analyzeShiftData(processData, headers) {
            const shiftColumn = findColumn(headers, ['교대', '조', 'shift']);
            const timeColumn = findColumn(headers, ['시간', '작업시간', 'time', 'hour']);
            const productionColumn = findColumn(headers, ['생산수량', 'production', 'quantity']);
            
            let shiftStats = {};
            
            if (shiftColumn) {
                // 교대 컬럼이 있는 경우
                processData.forEach(row => {
                    const shift = row[shiftColumn];
                    const production = parseFloat(row[productionColumn]) || 0;
                    
                    if (!shiftStats[shift]) {
                        shiftStats[shift] = { totalProduction: 0, records: 0 };
                    }
                    
                    shiftStats[shift].totalProduction += production;
                    shiftStats[shift].records += 1;
                });
            } else if (timeColumn) {
                // 시간으로 교대 추정
                processData.forEach(row => {
                    const timeValue = row[timeColumn];
                    const hour = extractHour(timeValue);
                    const production = parseFloat(row[productionColumn]) || 0;
                    
                    if (hour !== null) {
                        let shift = '주간조';
                        if (hour >= 6 && hour < 14) shift = '주간조';
                        else if (hour >= 14 && hour < 22) shift = '오후조';
                        else shift = '야간조';
                        
                        if (!shiftStats[shift]) {
                            shiftStats[shift] = { totalProduction: 0, records: 0 };
                        }
                        
                        shiftStats[shift].totalProduction += production;
                        shiftStats[shift].records += 1;
                    }
                });
            }
            
            // 교대별 생산성 계산
            Object.keys(shiftStats).forEach(shift => {
                const stats = shiftStats[shift];
                stats.productivity = (stats.totalProduction / stats.records).toFixed(2);
            });
            
            return Object.keys(shiftStats).length > 0 ? shiftStats : null;
        }
        
        // 6) 규격별 분석
        function analyzeSpecData(processData, headers) {
            const specColumn = findColumn(headers, ['규격', '모델', 'spec', 'model', 'type']);
            const productionColumn = findColumn(headers, ['생산수량', 'production', 'quantity']);
            const ctColumn = findColumn(headers, ['CT', 'C/T', 'cycle_time', 'cycletime']);
            const defectColumn = findColumn(headers, ['불량', '결함', 'defect', 'reject']);
            const equipmentColumn = findColumn(headers, ['설비', '장비', 'equipment', 'machine']);
            
            if (!specColumn) return null;
            
            const specStats = {};
            
            processData.forEach(row => {
                const spec = row[specColumn];
                const production = parseFloat(row[productionColumn]) || 0;
                const ct = parseFloat(row[ctColumn]) || 0;
                const defect = parseFloat(row[defectColumn]) || 0;
                const equipment = row[equipmentColumn];
                
                if (!specStats[spec]) {
                    specStats[spec] = {
                        totalProduction: 0,
                        totalDefect: 0,
                        totalCT: 0,
                        equipments: new Set(),
                        records: 0
                    };
                }
                
                specStats[spec].totalProduction += production;
                specStats[spec].totalDefect += defect;
                specStats[spec].totalCT += ct;
                specStats[spec].records += 1;
                if (equipment) specStats[spec].equipments.add(equipment);
            });
            
            // 규격별 지표 계산
            Object.keys(specStats).forEach(spec => {
                const stats = specStats[spec];
                stats.productivity = (stats.totalProduction / stats.records).toFixed(2);
                stats.avgCT = stats.records > 0 ? (stats.totalCT / stats.records).toFixed(2) : 0;
                stats.efficiency = stats.avgCT > 0 ? ((60 / stats.avgCT) * 100).toFixed(1) : 0; // 효율 = (표준 시간 / 실제 시간) * 100
                stats.defectRate = stats.totalProduction > 0 ? ((stats.totalDefect / stats.totalProduction) * 100).toFixed(2) : 0;
                stats.equipmentList = Array.from(stats.equipments);
            });
            
            return specStats;
        }
        
        // 7) 작업자별 설비 운영 실적
        function analyzeWorkerEquipmentData(processData, headers) {
            const workerColumn = findColumn(headers, ['작업자', '인원', 'worker', 'operator']);
            const equipmentColumn = findColumn(headers, ['설비', '장비', 'equipment', 'machine']);
            const productionColumn = findColumn(headers, ['생산수량', 'production', 'quantity']);
            
            if (!workerColumn || !equipmentColumn) return null;
            
            const workerEquipmentStats = {};
            
            processData.forEach(row => {
                const worker = row[workerColumn];
                const equipment = row[equipmentColumn];
                const production = parseFloat(row[productionColumn]) || 0;
                
                if (!workerEquipmentStats[worker]) {
                    workerEquipmentStats[worker] = {};
                }
                
                if (!workerEquipmentStats[worker][equipment]) {
                    workerEquipmentStats[worker][equipment] = {
                        totalProduction: 0,
                        records: 0
                    };
                }
                
                workerEquipmentStats[worker][equipment].totalProduction += production;
                workerEquipmentStats[worker][equipment].records += 1;
            });
            
            // 작업자별 설비 운영 대수 계산
            const result = {};
            Object.keys(workerEquipmentStats).forEach(worker => {
                const equipments = workerEquipmentStats[worker];
                result[worker] = {
                    equipmentCount: Object.keys(equipments).length,
                    equipmentDetails: equipments
                };
            });
            
            return result;
        }
        
        // 유틸리티 함수들
        function findColumn(headers, keywords) {
            return headers.find(header => 
                keywords.some(keyword => 
                    header.includes(keyword) || header.toLowerCase().includes(keyword.toLowerCase())
                )
            );
        }
        
        function getUniqueCount(data, column) {
            return new Set(data.map(row => row[column]).filter(val => val)).size;
        }
        
        function getSumValue(data, column) {
            return data.reduce((sum, row) => {
                const val = parseFloat(row[column]);
                return sum + (isNaN(val) ? 0 : val);
            }, 0);
        }
        
        function extractHour(timeValue) {
            if (!timeValue) return null;
            
            // 다양한 시간 형식 처리
            const timeStr = timeValue.toString();
            
            // HH:MM 형식
            const timeMatch = timeStr.match(/(\d{1,2}):(\d{2})/);
            if (timeMatch) {
                return parseInt(timeMatch[1]);
            }
            
            // 숫자만 있는 경우 (시간)
            const numMatch = timeStr.match(/^\d{1,2}$/);
            if (numMatch) {
                const hour = parseInt(timeStr);
                return hour >= 0 && hour <= 23 ? hour : null;
            }
            
            return null;
        }
        
        function analyzeTimeData(processData, dateColumn, productionColumn) {
            // 날짜별 생산량 집계
            const dateGroups = {};
            
            processData.forEach(row => {
                const dateValue = row[dateColumn];
                const production = parseFloat(row[productionColumn]);
                
                if (dateValue && !isNaN(production)) {
                    const dateKey = formatDate(dateValue);
                    if (!dateGroups[dateKey]) {
                        dateGroups[dateKey] = [];
                    }
                    dateGroups[dateKey].push(production);
                }
            });
            
            // 날짜별 통계 계산
            const dailyStats = Object.entries(dateGroups).map(([date, productions]) => ({
                date,
                total: productions.reduce((sum, val) => sum + val, 0),
                average: productions.reduce((sum, val) => sum + val, 0) / productions.length,
                count: productions.length
            })).sort((a, b) => new Date(a.date) - new Date(b.date));
            
            return {
                dailyStats,
                bestDay: dailyStats.reduce((max, day) => day.total > max.total ? day : max, dailyStats[0] || {}),
                worstDay: dailyStats.reduce((min, day) => day.total < min.total ? day : min, dailyStats[0] || {})
            };
        }
        
        function analyzeQualityData(processData, qualityColumns) {
            const qualityStats = {};
            
            qualityColumns.forEach(column => {
                const values = processData
                    .map(row => row[column])
                    .filter(val => val !== null && val !== undefined && val !== '');
                
                if (values.length > 0) {
                    qualityStats[column] = {
                        total: values.length,
                        unique: [...new Set(values)],
                        distribution: getValueDistribution(values)
                    };
                }
            });
            
            return qualityStats;
        }
        
        function getValueDistribution(values) {
            const distribution = {};
            values.forEach(val => {
                distribution[val] = (distribution[val] || 0) + 1;
            });
            return distribution;
        }
        
        function formatDate(dateValue) {
            try {
                const date = new Date(dateValue);
                return date.toISOString().split('T')[0]; // YYYY-MM-DD 형식
            } catch {
                return dateValue.toString();
            }
        }
        
        function displayProcessModal(processName, analysis, processNumber = null) {
            const modal = document.getElementById('processModal');
            const modalTitle = document.getElementById('modalTitle');
            const modalContent = document.getElementById('modalContent');
            
            const displayTitle = processNumber ? 
                `${processName} (${processNumber}) 공정 상세 분석` : 
                `${processName} 공정 상세 분석`;
                
            modalTitle.textContent = displayTitle;
            
            let contentHTML = '';
            
            // 1) 생산 현황 종합
            if (analysis.productionSummary) {
                const summary = analysis.productionSummary;
                contentHTML += `
                    <h3>📊 1) 생산 현황 종합</h3>
                    <div class="stat-grid">
                        <div class="stat-card">
                            <div class="stat-value">${summary.totalProduction.toLocaleString()}</div>
                            <div class="stat-label">총 생산수량</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">${summary.equipmentCount}</div>
                            <div class="stat-label">투입설비 대수</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">${summary.workerCount}</div>
                            <div class="stat-label">투입인원 수</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">${summary.totalWorkTime.toLocaleString()}</div>
                            <div class="stat-label">총 작업시간</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">${summary.avgUPH}</div>
                            <div class="stat-label">평균 UPH</div>
                        </div>
                    </div>
                `;
            }
            
            // 2) 설비별 분석
            if (analysis.equipmentAnalysis) {
                contentHTML += `<h3>🔧 2) 설비별 생산성 분석</h3>`;
                contentHTML += `<div style="overflow-x: auto;">`;
                contentHTML += `<table style="width: 100%; border-collapse: collapse; margin: 10px 0;">`;
                contentHTML += `<thead><tr style="background: #f0f0f0;">
                    <th style="padding: 8px; border: 1px solid #ddd;">설비명</th>
                    <th style="padding: 8px; border: 1px solid #ddd;">생산성</th>
                    <th style="padding: 8px; border: 1px solid #ddd;">가동율(%)</th>
                    <th style="padding: 8px; border: 1px solid #ddd;">불량율(%)</th>
                    <th style="padding: 8px; border: 1px solid #ddd;">소요인원</th>
                </tr></thead><tbody>`;
                
                Object.entries(analysis.equipmentAnalysis).forEach(([equipment, stats]) => {
                    contentHTML += `<tr>
                        <td style="padding: 8px; border: 1px solid #ddd;">${equipment}</td>
                        <td style="padding: 8px; border: 1px solid #ddd;">${stats.productivity}</td>
                        <td style="padding: 8px; border: 1px solid #ddd;">${stats.operationRate}%</td>
                        <td style="padding: 8px; border: 1px solid #ddd;">${stats.defectRate}%</td>
                        <td style="padding: 8px; border: 1px solid #ddd;">${stats.requiredWorkers}명</td>
                    </tr>`;
                });
                contentHTML += `</tbody></table></div>`;
            }
            
            // 3) 작업자별 분석
            if (analysis.workerAnalysis) {
                contentHTML += `<h3>👨‍🔧 3) 작업자별 생산성 분석</h3>`;
                contentHTML += `<div style="overflow-x: auto;">`;
                contentHTML += `<table style="width: 100%; border-collapse: collapse; margin: 10px 0;">`;
                contentHTML += `<thead><tr style="background: #f0f0f0;">
                    <th style="padding: 8px; border: 1px solid #ddd;">작업자</th>
                    <th style="padding: 8px; border: 1px solid #ddd;">생산성</th>
                    <th style="padding: 8px; border: 1px solid #ddd;">불량율(%)</th>
                    <th style="padding: 8px; border: 1px solid #ddd;">설비 운영 수</th>
                </tr></thead><tbody>`;
                
                Object.entries(analysis.workerAnalysis).forEach(([worker, stats]) => {
                    contentHTML += `<tr>
                        <td style="padding: 8px; border: 1px solid #ddd;">${worker}</td>
                        <td style="padding: 8px; border: 1px solid #ddd;">${stats.productivity}</td>
                        <td style="padding: 8px; border: 1px solid #ddd;">${stats.defectRate}%</td>
                        <td style="padding: 8px; border: 1px solid #ddd;">${stats.equipmentCount}대</td>
                    </tr>`;
                });
                contentHTML += `</tbody></table></div>`;
            }
            
            // 4) 시간대별 분석
            if (analysis.hourlyAnalysis) {
                contentHTML += `<h3>🕐 4) 24시간 시간대별 분석</h3>`;
                contentHTML += `<div class="stat-grid">`;
                
                Object.entries(analysis.hourlyAnalysis).sort(([a], [b]) => parseInt(a) - parseInt(b)).forEach(([hour, stats]) => {
                    contentHTML += `
                        <div class="stat-card">
                            <div class="stat-value">${hour}시</div>
                            <div class="stat-label">생산성: ${stats.productivity}<br>UPH: ${stats.uph}<br>불량율: ${stats.defectRate}%</div>
                        </div>
                    `;
                });
                contentHTML += `</div>`;
            }
            
            // 5) 교대별 분석
            if (analysis.shiftAnalysis) {
                contentHTML += `<h3>⏰ 5) 교대별 생산성 분석</h3>`;
                contentHTML += `<div class="stat-grid">`;
                
                Object.entries(analysis.shiftAnalysis).forEach(([shift, stats]) => {
                    contentHTML += `
                        <div class="stat-card">
                            <div class="stat-value">${stats.totalProduction.toLocaleString()}</div>
                            <div class="stat-label">${shift}<br>생산성: ${stats.productivity}</div>
                        </div>
                    `;
                });
                contentHTML += `</div>`;
            }
            
            // 6) 규격별 분석
            if (analysis.specAnalysis) {
                contentHTML += `<h3>� 6) 규격별 생산 실적 분석</h3>`;
                contentHTML += `<div style="overflow-x: auto;">`;
                contentHTML += `<table style="width: 100%; border-collapse: collapse; margin: 10px 0;">`;
                contentHTML += `<thead><tr style="background: #f0f0f0;">
                    <th style="padding: 8px; border: 1px solid #ddd;">규격</th>
                    <th style="padding: 8px; border: 1px solid #ddd;">총 생산량</th>
                    <th style="padding: 8px; border: 1px solid #ddd;">생산성</th>
                    <th style="padding: 8px; border: 1px solid #ddd;">평균 C/T</th>
                    <th style="padding: 8px; border: 1px solid #ddd;">효율(%)</th>
                    <th style="padding: 8px; border: 1px solid #ddd;">불량율(%)</th>
                    <th style="padding: 8px; border: 1px solid #ddd;">적용 설비</th>
                </tr></thead><tbody>`;
                
                Object.entries(analysis.specAnalysis).forEach(([spec, stats]) => {
                    contentHTML += `<tr>
                        <td style="padding: 8px; border: 1px solid #ddd;">${spec}</td>
                        <td style="padding: 8px; border: 1px solid #ddd;">${stats.totalProduction.toLocaleString()}</td>
                        <td style="padding: 8px; border: 1px solid #ddd;">${stats.productivity}</td>
                        <td style="padding: 8px; border: 1px solid #ddd;">${stats.avgCT}초</td>
                        <td style="padding: 8px; border: 1px solid #ddd;">${stats.efficiency}%</td>
                        <td style="padding: 8px; border: 1px solid #ddd;">${stats.defectRate}%</td>
                        <td style="padding: 8px; border: 1px solid #ddd;">${stats.equipmentList.join(', ')}</td>
                    </tr>`;
                });
                contentHTML += `</tbody></table></div>`;
            }
            
            // 7) 작업자별 설비 운영 실적
            if (analysis.workerEquipmentAnalysis) {
                contentHTML += `<h3>🔧👨‍🔧 7) 작업자별 설비 운영 실적</h3>`;
                contentHTML += `<div style="overflow-x: auto;">`;
                contentHTML += `<table style="width: 100%; border-collapse: collapse; margin: 10px 0;">`;
                contentHTML += `<thead><tr style="background: #f0f0f0;">
                    <th style="padding: 8px; border: 1px solid #ddd;">작업자</th>
                    <th style="padding: 8px; border: 1px solid #ddd;">운영 설비 수</th>
                    <th style="padding: 8px; border: 1px solid #ddd;">설비별 생산 실적</th>
                </tr></thead><tbody>`;
                
                Object.entries(analysis.workerEquipmentAnalysis).forEach(([worker, stats]) => {
                    const equipmentDetails = Object.entries(stats.equipmentDetails)
                        .map(([eq, data]) => `${eq}(${data.totalProduction})`)
                        .join(', ');
                    
                    contentHTML += `<tr>
                        <td style="padding: 8px; border: 1px solid #ddd;">${worker}</td>
                        <td style="padding: 8px; border: 1px solid #ddd;">${stats.equipmentCount}대</td>
                        <td style="padding: 8px; border: 1px solid #ddd;">${equipmentDetails}</td>
                    </tr>`;
                });
                contentHTML += `</tbody></table></div>`;
            }
            
            // 종합 인사이트
            contentHTML += `
                <h3>� 종합 분석 인사이트</h3>
                <div style="background: #e8f5e8; padding: 15px; border-radius: 6px; margin: 10px 0;">
                    ${generateComprehensiveInsights(analysis)}
                </div>
            `;
            
            modalContent.innerHTML = contentHTML;
            modal.style.display = 'block';
        }
        
        function getProductivityInsights(productivity) {
            let insights = [];
            
            if (productivity.efficiency >= 95) {
                insights.push("✅ 데이터 품질이 매우 우수합니다.");
            } else if (productivity.efficiency >= 80) {
                insights.push("⚠️ 일부 데이터 누락이 있습니다.");
            } else {
                insights.push("❌ 데이터 품질 개선이 필요합니다.");
            }
            
            const cv = productivity.variability / productivity.average; // 변동계수
            if (cv < 0.1) {
                insights.push("✅ 생산량이 매우 안정적입니다.");
            } else if (cv < 0.3) {
                insights.push("⚠️ 생산량에 약간의 변동이 있습니다.");
            } else {
                insights.push("❌ 생산량 변동이 큽니다. 공정 안정성 점검이 필요합니다.");
            }
            
            return insights.join('<br>');
        }
        
        function generateComprehensiveInsights(analysis) {
            let insights = [];
            
            // 생산 현황 인사이트
            if (analysis.productionSummary) {
                const summary = analysis.productionSummary;
                insights.push(`⚡ 총 생산수량: ${summary.totalProduction.toLocaleString()}개, 투입설비 ${summary.equipmentCount}대, 투입인원 ${summary.workerCount}명으로 운영`);
                insights.push(`📈 평균 UPH: ${summary.avgUPH}, 총 작업시간: ${summary.totalWorkTime.toLocaleString()}시간`);
            }
            
            // 설비 인사이트
            if (analysis.equipmentAnalysis) {
                const equipmentEntries = Object.entries(analysis.equipmentAnalysis);
                const bestEquipment = equipmentEntries.reduce((max, [name, stats]) => 
                    parseFloat(stats.productivity) > parseFloat(max.productivity) ? 
                    {name, productivity: stats.productivity} : max, 
                    {name: '', productivity: '0'}
                );
                insights.push(`🔧 최고 성능 설비: ${bestEquipment.name} (생산성: ${bestEquipment.productivity})`);
            }
            
            // 작업자 인사이트
            if (analysis.workerAnalysis) {
                const workerEntries = Object.entries(analysis.workerAnalysis);
                const bestWorker = workerEntries.reduce((max, [name, stats]) => 
                    parseFloat(stats.productivity) > parseFloat(max.productivity) ? 
                    {name, productivity: stats.productivity} : max, 
                    {name: '', productivity: '0'}
                );
                insights.push(`👨‍🔧 최고 성과 작업자: ${bestWorker.name} (생산성: ${bestWorker.productivity})`);
            }
            
            // 시간대 인사이트
            if (analysis.hourlyAnalysis) {
                const hourlyEntries = Object.entries(analysis.hourlyAnalysis);
                const peakHour = hourlyEntries.reduce((max, [hour, stats]) => 
                    parseFloat(stats.productivity) > parseFloat(max.productivity) ? 
                    {hour, productivity: stats.productivity} : max, 
                    {hour: '', productivity: '0'}
                );
                insights.push(`🕐 최고 생산성 시간대: ${peakHour.hour}시 (생산성: ${peakHour.productivity})`);
            }
            
            // 교대 인사이트
            if (analysis.shiftAnalysis) {
                const shiftEntries = Object.entries(analysis.shiftAnalysis);
                const bestShift = shiftEntries.reduce((max, [shift, stats]) => 
                    stats.totalProduction > max.production ? 
                    {shift, production: stats.totalProduction} : max, 
                    {shift: '', production: 0}
                );
                insights.push(`⏰ 최고 생산 교대: ${bestShift.shift} (총 생산량: ${bestShift.production.toLocaleString()}개)`);
            }
            
            // 규격 인사이트
            if (analysis.specAnalysis) {
                const specEntries = Object.entries(analysis.specAnalysis);
                const topSpec = specEntries.reduce((max, [spec, stats]) => 
                    stats.totalProduction > max.production ? 
                    {spec, production: stats.totalProduction} : max, 
                    {spec: '', production: 0}
                );
                insights.push(`📏 주력 규격: ${topSpec.spec} (총 생산량: ${topSpec.production.toLocaleString()}개)`);
            }
            
            return insights.join('<br>• ');
        }
        
    </script>
</body>
</html>
