<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì—‘ì…€ ë°ì´í„° ë¶„ì„ - ìƒì‚°ìˆ˜ëŸ‰ í•©ê³„</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            text-align: center;
        }
        .result-box {
            background: #e8f5e8;
            border: 2px solid #4CAF50;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            text-align: center;
        }
        .process-item {
            background: #f9f9f9;
            border: 1px solid #ddd;
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .process-name {
            font-weight: bold;
            color: #333;
        }
        .process-quantity {
            font-size: 18px;
            font-weight: bold;
            color: #2e7d32;
        }
        .detail-btn {
            background-color: #2196F3;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        .stat-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        .stat-card {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 6px;
            padding: 15px;
            text-align: center;
        }
        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #2e7d32;
        }
        .stat-label {
            font-size: 14px;
            color: #666;
            margin-top: 5px;
        }
        .total-sum {
            font-size: 24px;
            font-weight: bold;
            color: #2e7d32;
        }
        .data-info {
            background: #f0f0f0;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        th {
            background-color: #f2f2f2;
            font-weight: bold;
        }
        tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        .btn {
            background-color: #4CAF50;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
        }
        .btn:hover {
            background-color: #45a049;
        }
        .btn:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        #loading-indicator {
            background-color: #e3f2fd;
            border: 1px solid #2196F3;
            padding: 15px;
            border-radius: 5px;
            color: #1976d2;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ì—‘ì…€ ë°ì´í„° ë¶„ì„ - ê³µì •ëª…ë³„ ìƒì‚°ìˆ˜ëŸ‰ í•©ê³„</h1>
        
        <div id="loading-indicator" style="display: none; text-align: center; margin: 20px;">
            <p>ğŸ“Š ì—‘ì…€ íŒŒì¼ì„ ë¡œë”© ì¤‘ì…ë‹ˆë‹¤...</p>
        </div>
        
        <input type="file" id="fileInput" accept=".xlsx,.xls" style="display: none;">
        <button id="loadBtn" class="btn">ì—‘ì…€ íŒŒì¼ ì„ íƒí•˜ê¸°</button>
        
        <div id="result-container" style="display: none;">
            <div class="result-box">
                <h2>ê³µì •ëª…ë³„ ìƒì‚°ìˆ˜ëŸ‰ í•©ê³„</h2>
                <div id="process-results"></div>
            </div>
            
            <div id="data-info" class="data-info">
                <p><strong>ë°ì´í„° ì •ë³´:</strong></p>
                <div id="info-details"></div>
            </div>
        </div>
    </div>

    <script>
        let excelData = [];
        
        document.getElementById('loadBtn').addEventListener('click', () => {
            document.getElementById('fileInput').click();
        });
        
        document.getElementById('fileInput').addEventListener('change', handleFileSelect);
        
        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            loadExcelFile(file);
        }
        
        async function loadExcelFile(file) {
            const loadBtn = document.getElementById('loadBtn');
            const loadingIndicator = document.getElementById('loading-indicator');
            
            try {
                // ë¡œë”© ìƒíƒœ í‘œì‹œ
                loadBtn.disabled = true;
                loadBtn.textContent = 'ë¡œë”© ì¤‘...';
                loadingIndicator.style.display = 'block';
                
                const arrayBuffer = await file.arrayBuffer();
                const workbook = XLSX.read(arrayBuffer, { type: 'array' });
                
                // ì²« ë²ˆì§¸ ì‹œíŠ¸ ì½ê¸°
                const firstSheetName = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[firstSheetName];
                
                // JSONìœ¼ë¡œ ë³€í™˜ (ì²« í–‰ì„ í—¤ë”ë¡œ ì‚¬ìš©)
                excelData = XLSX.utils.sheet_to_json(worksheet);
                
                console.log('ë¡œë“œëœ ë°ì´í„°:', excelData);
                console.log('ì‹œíŠ¸ ì´ë¦„ë“¤:', workbook.SheetNames);
                
                // ë°ì´í„° ë¶„ì„ ë° í‘œì‹œ
                analyzeData();
                
            } catch (error) {
                alert('íŒŒì¼ ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
                console.error('ìƒì„¸ ì˜¤ë¥˜ ì •ë³´:', error);
            } finally {
                // ë¡œë”© ìƒíƒœ í•´ì œ
                loadBtn.disabled = false;
                loadBtn.textContent = 'ì—‘ì…€ íŒŒì¼ ì„ íƒí•˜ê¸°';
                loadingIndicator.style.display = 'none';
            }
        }
        
        function generateProcessDetailHTML(processName, analysis, processNumber = null) {
            try {
                if (!analysis) {
                    return `
                        <div class="process-detail" style="margin: 20px 0; padding: 20px; background: #f8f9fa; border-radius: 8px; border-left: 4px solid #dc3545;">
                            <h3 style="color: #dc3545; margin-bottom: 20px;">${processName} - ë¶„ì„ ë°ì´í„° ì—†ìŒ</h3>
                            <p style="color: #666;">ë¶„ì„í•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
                        </div>
                    `;
                }

                const displayTitle = processNumber ? 
                    `${processName} (${processNumber}) ê³µì • ìƒì„¸ ë¶„ì„` : 
                    `${processName} ê³µì • ìƒì„¸ ë¶„ì„`;
                    
                let contentHTML = `
                    <div class="process-detail" style="margin: 40px 0; padding: 40px; background: #f8f9fa; border-radius: 12px; border-left: 6px solid #007bff; box-shadow: 0 4px 8px rgba(0,0,0,0.1);">
                        <h2 style="color: #007bff; margin-bottom: 30px; font-size: 28px;">${displayTitle}</h2>
                `;
                
                // 1) ìƒì‚° í˜„í™© ì¢…í•©
                if (analysis.productionSummary) {
                    const summary = analysis.productionSummary;
                    contentHTML += `
                        <h3 style="color: #333; margin: 30px 0 20px 0; font-size: 22px; border-bottom: 2px solid #007bff; padding-bottom: 10px;">ğŸ“Š 1) ìƒì‚° í˜„í™© ì¢…í•©</h3>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 40px;">
                            <div style="background: white; padding: 25px; border-radius: 8px; text-align: center; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                                <div style="font-size: 32px; font-weight: bold; color: #007bff; margin-bottom: 10px;">${(summary.totalProduction || 0).toLocaleString()}</div>
                                <div style="font-size: 16px; color: #666;">ì´ ìƒì‚°ìˆ˜ëŸ‰</div>
                            </div>
                            <div style="background: white; padding: 25px; border-radius: 8px; text-align: center; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                                <div style="font-size: 32px; font-weight: bold; color: #28a745; margin-bottom: 10px;">${summary.equipmentCount || 0}</div>
                                <div style="font-size: 16px; color: #666;">íˆ¬ì…ì„¤ë¹„ ëŒ€ìˆ˜</div>
                            </div>
                            <div style="background: white; padding: 25px; border-radius: 8px; text-align: center; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                                <div style="font-size: 32px; font-weight: bold; color: #ffc107; margin-bottom: 10px;">${summary.workerCount || 0}</div>
                                <div style="font-size: 16px; color: #666;">íˆ¬ì…ì¸ì› ìˆ˜</div>
                            </div>
                            <div style="background: white; padding: 25px; border-radius: 8px; text-align: center; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                                <div style="font-size: 32px; font-weight: bold; color: #17a2b8; margin-bottom: 10px;">${(summary.totalWorkTime || 0).toLocaleString()}</div>
                                <div style="font-size: 16px; color: #666;">ì´ ì‘ì—…ì‹œê°„</div>
                            </div>
                            <div style="background: white; padding: 25px; border-radius: 8px; text-align: center; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                                <div style="font-size: 32px; font-weight: bold; color: #6f42c1; margin-bottom: 10px;">${summary.avgUPH || 'N/A'}</div>
                                <div style="font-size: 16px; color: #666;">í‰ê·  UPH</div>
                            </div>
                        </div>
                    `;
                }
                
                // 2) ì„¤ë¹„ë³„ ë¶„ì„
                if (analysis.equipmentAnalysis && Object.keys(analysis.equipmentAnalysis).length > 0) {
                    contentHTML += `
                        <h3 style="color: #333; margin: 30px 0 20px 0; font-size: 22px; border-bottom: 2px solid #28a745; padding-bottom: 10px;">ğŸ”§ 2) ì„¤ë¹„ë³„ ìƒì‚°ì„± ë¶„ì„</h3>
                        <div style="overflow-x: auto; background: white; border-radius: 8px; margin-bottom: 40px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                            <table style="width: 100%; border-collapse: collapse;">
                                <thead>
                                    <tr style="background: #28a745; color: white;">
                                        <th style="padding: 15px; border: 1px solid #ddd; font-size: 16px; font-weight: bold;">ì„¤ë¹„ëª…</th>
                                        <th style="padding: 15px; border: 1px solid #ddd; font-size: 16px; font-weight: bold;">ìƒì‚°ì„±</th>
                                        <th style="padding: 15px; border: 1px solid #ddd; font-size: 16px; font-weight: bold;">ê°€ë™ìœ¨(%)</th>
                                        <th style="padding: 15px; border: 1px solid #ddd; font-size: 16px; font-weight: bold;">ë¶ˆëŸ‰ìœ¨(%)</th>
                                        <th style="padding: 15px; border: 1px solid #ddd; font-size: 16px; font-weight: bold;">ì†Œìš”ì¸ì›</th>
                                    </tr>
                                </thead>
                                <tbody>`;
                    
                    Object.entries(analysis.equipmentAnalysis).forEach(([equipment, stats]) => {
                        contentHTML += `
                            <tr style="border-bottom: 1px solid #eee;">
                                <td style="padding: 15px; border: 1px solid #ddd; font-size: 15px; font-weight: 500;">${equipment}</td>
                                <td style="padding: 15px; border: 1px solid #ddd; font-size: 15px; text-align: center;">${stats.productivity || 'N/A'}</td>
                                <td style="padding: 15px; border: 1px solid #ddd; font-size: 15px; text-align: center;">${stats.operationRate || 0}%</td>
                                <td style="padding: 15px; border: 1px solid #ddd; font-size: 15px; text-align: center;">${stats.defectRate || 0}%</td>
                                <td style="padding: 15px; border: 1px solid #ddd; font-size: 15px; text-align: center;">${stats.requiredWorkers || 0}ëª…</td>
                            </tr>`;
                    });
                    contentHTML += `</tbody></table></div>`;
                }
                
                // 3) ì‘ì—…ìë³„ ë¶„ì„
                if (analysis.workerAnalysis && Object.keys(analysis.workerAnalysis).length > 0) {
                    contentHTML += `
                        <h3 style="color: #333; margin: 30px 0 20px 0; font-size: 22px; border-bottom: 2px solid #ffc107; padding-bottom: 10px;">ğŸ‘¨â€ğŸ”§ 3) ì‘ì—…ìë³„ ìƒì‚°ì„± ë¶„ì„</h3>
                        <div style="overflow-x: auto; background: white; border-radius: 8px; margin-bottom: 40px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                            <table style="width: 100%; border-collapse: collapse;">
                                <thead>
                                    <tr style="background: #ffc107; color: #212529;">
                                        <th style="padding: 15px; border: 1px solid #ddd; font-size: 16px; font-weight: bold;">ì‘ì—…ì</th>
                                        <th style="padding: 15px; border: 1px solid #ddd; font-size: 16px; font-weight: bold;">ìƒì‚°ì„±</th>
                                        <th style="padding: 15px; border: 1px solid #ddd; font-size: 16px; font-weight: bold;">ë¶ˆëŸ‰ìœ¨(%)</th>
                                        <th style="padding: 15px; border: 1px solid #ddd; font-size: 16px; font-weight: bold;">ì„¤ë¹„ ìš´ì˜ ìˆ˜</th>
                                    </tr>
                                </thead>
                                <tbody>`;
                    
                    Object.entries(analysis.workerAnalysis).forEach(([worker, stats]) => {
                        contentHTML += `
                            <tr style="border-bottom: 1px solid #eee;">
                                <td style="padding: 15px; border: 1px solid #ddd; font-size: 15px; font-weight: 500;">${worker}</td>
                                <td style="padding: 15px; border: 1px solid #ddd; font-size: 15px; text-align: center;">${stats.productivity || 'N/A'}</td>
                                <td style="padding: 15px; border: 1px solid #ddd; font-size: 15px; text-align: center;">${stats.defectRate || 0}%</td>
                                <td style="padding: 15px; border: 1px solid #ddd; font-size: 15px; text-align: center;">${stats.equipmentCount || 0}ëŒ€</td>
                            </tr>`;
                    });
                    contentHTML += `</tbody></table></div>`;
                }
                
                // 4) ì‹œê°„ëŒ€ë³„ ë¶„ì„
                if (analysis.hourlyAnalysis && Object.keys(analysis.hourlyAnalysis).length > 0) {
                    contentHTML += `
                        <h3 style="color: #333; margin: 30px 0 20px 0; font-size: 22px; border-bottom: 2px solid #17a2b8; padding-bottom: 10px;">ğŸ• 4) 24ì‹œê°„ ì‹œê°„ëŒ€ë³„ ë¶„ì„</h3>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 40px;">`;
                    
                    Object.entries(analysis.hourlyAnalysis).sort(([a], [b]) => parseInt(a) - parseInt(b)).forEach(([hour, stats]) => {
                        contentHTML += `
                            <div style="background: white; padding: 25px; border-radius: 8px; text-align: center; box-shadow: 0 2px 4px rgba(0,0,0,0.1); border: 2px solid #17a2b8;">
                                <div style="font-size: 32px; font-weight: bold; color: #17a2b8; margin-bottom: 15px;">${hour}ì‹œ</div>
                                <div style="font-size: 16px; color: #666; line-height: 2;">
                                    ìƒì‚°ì„±: <strong>${stats.productivity || 'N/A'}</strong><br>
                                    UPH: <strong>${stats.uph || 'N/A'}</strong><br>
                                    ë¶ˆëŸ‰ìœ¨: <strong>${stats.defectRate || 0}%</strong>
                                </div>
                            </div>
                        `;
                    });
                    contentHTML += `</div>`;
                }
                
                // 5) êµëŒ€ë³„ ë¶„ì„
                if (analysis.shiftAnalysis && Object.keys(analysis.shiftAnalysis).length > 0) {
                    contentHTML += `
                        <h3 style="color: #333; margin: 30px 0 20px 0; font-size: 22px; border-bottom: 2px solid #6f42c1; padding-bottom: 10px;">â° 5) êµëŒ€ë³„ ìƒì‚°ì„± ë¶„ì„</h3>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 25px; margin-bottom: 40px;">`;
                    
                    Object.entries(analysis.shiftAnalysis).forEach(([shift, stats]) => {
                        contentHTML += `
                            <div style="background: white; padding: 30px; border-radius: 8px; text-align: center; box-shadow: 0 2px 4px rgba(0,0,0,0.1); border: 2px solid #6f42c1;">
                                <div style="font-size: 36px; font-weight: bold; color: #6f42c1; margin-bottom: 15px;">${(stats.totalProduction || 0).toLocaleString()}</div>
                                <div style="font-size: 20px; color: #333; margin-bottom: 10px;">${shift}</div>
                                <div style="font-size: 16px; color: #666;">ìƒì‚°ì„±: <strong>${stats.productivity || 'N/A'}</strong></div>
                            </div>
                        `;
                    });
                    contentHTML += `</div>`;
                }
                
                // 6) ê·œê²©ë³„ ë¶„ì„
                if (analysis.specAnalysis && Object.keys(analysis.specAnalysis).length > 0) {
                    contentHTML += `
                        <h3 style="color: #333; margin: 30px 0 20px 0; font-size: 22px; border-bottom: 2px solid #dc3545; padding-bottom: 10px;">ğŸ“ 6) ê·œê²©ë³„ ìƒì‚° ì‹¤ì  ë¶„ì„</h3>
                        <div style="overflow-x: auto; background: white; border-radius: 8px; margin-bottom: 40px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                            <table style="width: 100%; border-collapse: collapse;">
                                <thead>
                                    <tr style="background: #dc3545; color: white;">
                                        <th style="padding: 15px; border: 1px solid #ddd; font-size: 16px; font-weight: bold;">ê·œê²©</th>
                                        <th style="padding: 15px; border: 1px solid #ddd; font-size: 16px; font-weight: bold;">ì´ ìƒì‚°ëŸ‰</th>
                                        <th style="padding: 15px; border: 1px solid #ddd; font-size: 16px; font-weight: bold;">ìƒì‚°ì„±</th>
                                        <th style="padding: 15px; border: 1px solid #ddd; font-size: 16px; font-weight: bold;">í‰ê·  C/T</th>
                                        <th style="padding: 15px; border: 1px solid #ddd; font-size: 16px; font-weight: bold;">íš¨ìœ¨(%)</th>
                                        <th style="padding: 15px; border: 1px solid #ddd; font-size: 16px; font-weight: bold;">ë¶ˆëŸ‰ìœ¨(%)</th>
                                        <th style="padding: 15px; border: 1px solid #ddd; font-size: 16px; font-weight: bold;">ì ìš© ì„¤ë¹„</th>
                                    </tr>
                                </thead>
                                <tbody>`;
                    
                    Object.entries(analysis.specAnalysis).forEach(([spec, stats]) => {
                        contentHTML += `
                            <tr style="border-bottom: 1px solid #eee;">
                                <td style="padding: 15px; border: 1px solid #ddd; font-size: 15px; font-weight: 500;">${spec}</td>
                                <td style="padding: 15px; border: 1px solid #ddd; font-size: 15px; text-align: center;">${(stats.totalProduction || 0).toLocaleString()}</td>
                                <td style="padding: 15px; border: 1px solid #ddd; font-size: 15px; text-align: center;">${stats.productivity || 'N/A'}</td>
                                <td style="padding: 15px; border: 1px solid #ddd; font-size: 15px; text-align: center;">${stats.avgCT || 'N/A'}ì´ˆ</td>
                                <td style="padding: 15px; border: 1px solid #ddd; font-size: 15px; text-align: center;">${stats.efficiency || 0}%</td>
                                <td style="padding: 15px; border: 1px solid #ddd; font-size: 15px; text-align: center;">${stats.defectRate || 0}%</td>
                                <td style="padding: 15px; border: 1px solid #ddd; font-size: 15px;">${(stats.equipmentList || []).join(', ')}</td>
                            </tr>`;
                    });
                    contentHTML += `</tbody></table></div>`;
                }
                
                // 7) ì‘ì—…ìë³„ ì„¤ë¹„ ìš´ì˜ ì‹¤ì 
                if (analysis.workerEquipmentAnalysis && Object.keys(analysis.workerEquipmentAnalysis).length > 0) {
                    contentHTML += `
                        <h3 style="color: #333; margin: 30px 0 20px 0; font-size: 22px; border-bottom: 2px solid #fd7e14; padding-bottom: 10px;">ğŸ”§ğŸ‘¨â€ğŸ”§ 7) ì‘ì—…ìë³„ ì„¤ë¹„ ìš´ì˜ ì‹¤ì </h3>
                        <div style="overflow-x: auto; background: white; border-radius: 8px; margin-bottom: 40px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                            <table style="width: 100%; border-collapse: collapse;">
                                <thead>
                                    <tr style="background: #fd7e14; color: white;">
                                        <th style="padding: 15px; border: 1px solid #ddd; font-size: 16px; font-weight: bold;">ì‘ì—…ì</th>
                                        <th style="padding: 15px; border: 1px solid #ddd; font-size: 16px; font-weight: bold;">ìš´ì˜ ì„¤ë¹„ ìˆ˜</th>
                                        <th style="padding: 15px; border: 1px solid #ddd; font-size: 16px; font-weight: bold;">ì„¤ë¹„ë³„ ìƒì‚° ì‹¤ì </th>
                                    </tr>
                                </thead>
                                <tbody>`;
                    
                    Object.entries(analysis.workerEquipmentAnalysis).forEach(([worker, stats]) => {
                        const equipmentDetails = Object.entries(stats.equipmentDetails || {})
                            .map(([eq, data]) => `${eq}(${(data.totalProduction || 0).toLocaleString()})`)
                            .join(', ');
                        
                        contentHTML += `
                            <tr style="border-bottom: 1px solid #eee;">
                                <td style="padding: 15px; border: 1px solid #ddd; font-size: 15px; font-weight: 500;">${worker}</td>
                                <td style="padding: 15px; border: 1px solid #ddd; font-size: 15px; text-align: center;">${stats.equipmentCount || 0}ëŒ€</td>
                                <td style="padding: 15px; border: 1px solid #ddd; font-size: 15px;">${equipmentDetails || 'N/A'}</td>
                            </tr>`;
                    });
                    contentHTML += `</tbody></table></div>`;
                }
                
                // ì¢…í•© ì¸ì‚¬ì´íŠ¸ë§Œ ê°„ë‹¨íˆ í‘œì‹œ
                try {
                    if (typeof generateComprehensiveInsights === 'function') {
                        const insights = generateComprehensiveInsights(analysis);
                        if (insights) {
                            contentHTML += `
                                <h4 style="color: #333; margin: 15px 0 10px 0;">ï¿½ ì¢…í•© ë¶„ì„ ì¸ì‚¬ì´íŠ¸</h4>
                                <div style="background: #e8f5e8; padding: 15px; border-radius: 6px; margin: 10px 0; font-size: 13px;">
                                    ${insights}
                                </div>
                            `;
                        }
                    }
                } catch (insightError) {
                    console.warn('ì¸ì‚¬ì´íŠ¸ ìƒì„± ì¤‘ ì˜¤ë¥˜:', insightError);
                }
                
                contentHTML += `</div>`;
                return contentHTML;
                
            } catch (error) {
                console.error('ìƒì„¸ ë¶„ì„ ìƒì„± ì¤‘ ì˜¤ë¥˜:', error);
                return `
                    <div class="process-detail" style="margin: 40px 0; padding: 40px; background: #f8f9fa; border-radius: 12px; border-left: 6px solid #dc3545;">
                        <h2 style="color: #dc3545; margin-bottom: 20px; font-size: 24px;">${processName || 'ì•Œ ìˆ˜ ì—†ìŒ'} ê³µì • ë¶„ì„ ì˜¤ë¥˜</h2>
                        <p style="color: #666; font-size: 16px;">ìƒì„¸ ë¶„ì„ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${error.message}</p>
                    </div>
                `;
            }
        }

        function createProcessMapping(data, processColumn, itemColumn) {
            const mapping = {};
            
            if (!itemColumn) {
                console.warn('í’ˆëª© ì»¬ëŸ¼ì„ ì°¾ì„ ìˆ˜ ì—†ì–´ ê³µì •ë²ˆí˜¸ë¥¼ ì¶”ì¶œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                return mapping;
            }
            
            data.forEach(row => {
                const processName = row[processColumn];
                const itemCode = row[itemColumn];
                
                if (processName && itemCode) {
                    // í’ˆëª© ì½”ë“œì—ì„œ ë§ˆì§€ë§‰ 3ìë¦¬ ì¶”ì¶œ
                    const processNumber = extractProcessNumber(itemCode);
                    if (processNumber && !mapping[processName]) {
                        mapping[processName] = processNumber;
                    }
                }
            });
            
            return mapping;
        }
        
        function extractProcessNumber(itemCode) {
            if (!itemCode) return null;
            
            // ë¬¸ìì—´ë¡œ ë³€í™˜í•˜ê³  ìˆ«ìë§Œ ì¶”ì¶œ
            const codeStr = itemCode.toString();
            const numbers = codeStr.replace(/[^\d]/g, ''); // ìˆ«ìê°€ ì•„ë‹Œ ë¬¸ì ì œê±°
            
            if (numbers.length >= 3) {
                return numbers.slice(-3); // ë§ˆì§€ë§‰ 3ìë¦¬
            }
            
            return null;
        }

        function analyzeData() {
            if (excelData.length === 0) {
                alert('ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }
            
            const headers = Object.keys(excelData[0]);
            console.log('í—¤ë”:', headers);
            
            // ê³µì •ëª… ì»¬ëŸ¼ ì°¾ê¸°
            const processColumn = headers.find(header => 
                header.includes('ê³µì •ëª…') || 
                header === 'ê³µì •ëª…' ||
                header.toLowerCase().includes('process')
            );
            
            // í’ˆëª© ì»¬ëŸ¼ ì°¾ê¸° (ê³µì •ë²ˆí˜¸ ì¶”ì¶œìš©)
            const itemColumn = headers.find(header => 
                header.includes('í’ˆëª©') || 
                header === 'í’ˆëª©' ||
                header.toLowerCase().includes('item') ||
                header.toLowerCase().includes('product')
            );
            
            // ìƒì‚°ìˆ˜ëŸ‰ ì»¬ëŸ¼ ì°¾ê¸°
            const productionColumn = headers.find(header => 
                header.includes('ìƒì‚°ìˆ˜ëŸ‰') || 
                header === 'ìƒì‚°ìˆ˜ëŸ‰' ||
                header.toLowerCase().includes('production') ||
                header.toLowerCase().includes('quantity')
            );
            
            if (!processColumn) {
                alert(`ê³µì •ëª… ì»¬ëŸ¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.\nì‚¬ìš© ê°€ëŠ¥í•œ ì»¬ëŸ¼: ${headers.join(', ')}`);
                console.log('ì‚¬ìš© ê°€ëŠ¥í•œ ì»¬ëŸ¼ë“¤:', headers);
                return;
            }
            
            if (!productionColumn) {
                alert(`ìƒì‚°ìˆ˜ëŸ‰ ì»¬ëŸ¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.\nì‚¬ìš© ê°€ëŠ¥í•œ ì»¬ëŸ¼: ${headers.join(', ')}`);
                console.log('ì‚¬ìš© ê°€ëŠ¥í•œ ì»¬ëŸ¼ë“¤:', headers);
                return;
            }
            
            // ê³µì •ë²ˆí˜¸ì™€ ê³µì •ëª… ë§¤í•‘ ìƒì„±
            const processMapping = createProcessMapping(excelData, processColumn, itemColumn);
            
            // ê³µì •ëª…ë³„ ìƒì‚°ìˆ˜ëŸ‰ ì§‘ê³„
            const processResults = {};
            let totalValidRows = 0;
            let totalInvalidRows = 0;
            let grandTotal = 0;
            
            excelData.forEach((row, index) => {
                const processName = row[processColumn];
                const productionValue = row[productionColumn];
                
                if (processName && productionValue !== null && productionValue !== undefined && productionValue !== '') {
                    const numValue = parseFloat(productionValue);
                    if (!isNaN(numValue)) {
                        if (!processResults[processName]) {
                            processResults[processName] = {
                                total: 0,
                                count: 0,
                                processNumber: processMapping[processName] || '000'
                            };
                        }
                        processResults[processName].total += numValue;
                        processResults[processName].count += 1;
                        totalValidRows++;
                        grandTotal += numValue;
                    } else {
                        totalInvalidRows++;
                        console.warn(`í–‰ ${index + 2}: ìœ íš¨í•˜ì§€ ì•Šì€ ìˆ«ì ê°’ "${productionValue}"`);
                    }
                } else {
                    totalInvalidRows++;
                }
            });
            
            // ê²°ê³¼ í‘œì‹œ
            displayProcessResults(processResults, processColumn, productionColumn, totalValidRows, totalInvalidRows, grandTotal, headers);
        }
        
        function displayProcessResults(processResults, processColumnName, productionColumnName, totalValidRows, totalInvalidRows, grandTotal, headers) {
            // ê²°ê³¼ ì»¨í…Œì´ë„ˆ í‘œì‹œ
            document.getElementById('result-container').style.display = 'block';
            
            // ê³µì •ë³„ ê²°ê³¼ í‘œì‹œ
            const processResultsDiv = document.getElementById('process-results');
            let resultsHTML = '';
            
            // ê³µì •ëª…ë³„ ê²°ê³¼ë¥¼ ê³µì •ë²ˆí˜¸ ìˆœìœ¼ë¡œ ì •ë ¬
            const sortedProcesses = Object.entries(processResults)
                .sort(([,a], [,b]) => {
                    const numA = parseInt(a.processNumber) || 999;
                    const numB = parseInt(b.processNumber) || 999;
                    return numA - numB;
                });
            
            sortedProcesses.forEach(([processName, data]) => {
                const percentage = ((data.total / grandTotal) * 100).toFixed(1);
                const displayName = data.processNumber ? 
                    `${processName} (${data.processNumber})` : 
                    processName;
                    
                resultsHTML += `
                    <div class="process-item">
                        <div class="process-name">${displayName}</div>
                        <div class="process-quantity">
                            ${data.total.toLocaleString()} (${percentage}%)
                            <br><small>${data.count}ê±´</small>
                        </div>
                    </div>
                `;
                
                // ê° ê³µì •ë³„ ìƒì„¸ ë¶„ì„ ë‚´ìš© ì¶”ê°€
                const processData = excelData.filter(row => row[processColumnName] === processName);
                if (processData.length > 0) {
                    const analysis = analyzeProcessData(processData, processName, productionColumnName, headers);
                    const processNumber = data.processNumber;
                    resultsHTML += generateProcessDetailHTML(processName, analysis, processNumber);
                }
            });
            
            // ì „ì²´ í•©ê³„ ì¶”ê°€
            resultsHTML += `
                <div class="process-item" style="background: #e8f5e8; border: 2px solid #4CAF50; font-weight: bold;">
                    <div class="process-name">ğŸ“Š ì „ì²´ í•©ê³„</div>
                    <div class="process-quantity" style="font-size: 20px;">
                        ${grandTotal.toLocaleString()}
                    </div>
                </div>
            `;
            
            processResultsDiv.innerHTML = resultsHTML;
            
            // ë°ì´í„° ì •ë³´ í‘œì‹œ
            const infoDetails = document.getElementById('info-details');
            infoDetails.innerHTML = `
                <p>â€¢ ì „ì²´ í–‰ ìˆ˜: ${excelData.length.toLocaleString()}ê°œ</p>
                <p>â€¢ ìœ íš¨í•œ ë°ì´í„°: ${totalValidRows.toLocaleString()}ê°œ</p>
                <p>â€¢ ë¬´íš¨í•œ ë°ì´í„°: ${totalInvalidRows.toLocaleString()}ê°œ</p>
                <p>â€¢ ê³µì •ëª… ì»¬ëŸ¼: "${processColumnName}"</p>
                <p>â€¢ ìƒì‚°ìˆ˜ëŸ‰ ì»¬ëŸ¼: "${productionColumnName}"</p>
                <p>â€¢ ê³µì • ì¢…ë¥˜: ${Object.keys(processResults).length}ê°œ</p>
                <p>â€¢ ì „ì²´ ìƒì‚°ìˆ˜ëŸ‰: ${grandTotal.toLocaleString()}</p>
                <p>â€¢ í‰ê·  ìƒì‚°ìˆ˜ëŸ‰: ${totalValidRows > 0 ? (grandTotal / totalValidRows).toFixed(2) : 0}</p>
            `;
        }

        function analyzeProcessData(processData, processName, productionColumn, headers) {
            const productions = processData
                .map(row => parseFloat(row[productionColumn]))
                .filter(val => !isNaN(val));
            
            const totalProduction = productions.reduce((sum, val) => sum + val, 0);
            const avgProduction = productions.length > 0 ? totalProduction / productions.length : 0;
            
            // 1) ìƒì‚° í˜„í™© ì¢…í•© ë¶„ì„
            const productionSummary = analyzeProductionSummary(processData, headers, totalProduction);
            
            // 2) ì„¤ë¹„ë³„ ë¶„ì„
            const equipmentAnalysis = analyzeEquipmentData(processData, headers);
            
            // 3) ì‘ì—…ìë³„ ë¶„ì„
            const workerAnalysis = analyzeWorkerData(processData, headers);
            
            // 4) ì‹œê°„ëŒ€ë³„ ë¶„ì„
            const hourlyAnalysis = analyzeHourlyData(processData, headers);
            
            // 5) êµëŒ€ë³„ ë¶„ì„
            const shiftAnalysis = analyzeShiftData(processData, headers);
            
            // 6) ê·œê²©ë³„ ë¶„ì„
            const specAnalysis = analyzeSpecData(processData, headers);
            
            // 7) ì‘ì—…ìë³„ ì„¤ë¹„ ìš´ì˜ ì‹¤ì 
            const workerEquipmentAnalysis = analyzeWorkerEquipmentData(processData, headers);
            
            return {
                productionSummary,
                equipmentAnalysis,
                workerAnalysis,
                hourlyAnalysis,
                shiftAnalysis,
                specAnalysis,
                workerEquipmentAnalysis,
                rawData: processData.slice(0, 5) // ìƒìœ„ 5ê°œ ì›ë³¸ ë°ì´í„°
            };
        }
        
        function calculateStandardDeviation(values) {
            const mean = values.reduce((sum, val) => sum + val, 0) / values.length;
            const squaredDiffs = values.map(val => Math.pow(val - mean, 2));
            const avgSquaredDiff = squaredDiffs.reduce((sum, val) => sum + val, 0) / values.length;
            return Math.sqrt(avgSquaredDiff);
        }
        
        // 1) ìƒì‚° í˜„í™© ì¢…í•© ë¶„ì„
        function analyzeProductionSummary(processData, headers, totalProduction) {
            const equipmentColumn = findColumn(headers, ['ì„¤ë¹„', 'ì¥ë¹„', 'equipment', 'machine']);
            const workerColumn = findColumn(headers, ['ì‘ì—…ì', 'ì¸ì›', 'worker', 'operator']);
            const timeColumn = findColumn(headers, ['ì‘ì—…ì‹œê°„', 'ìš´ì˜ì‹œê°„', 'time', 'hour']);
            
            const equipmentCount = equipmentColumn ? getUniqueCount(processData, equipmentColumn) : 0;
            const workerCount = workerColumn ? getUniqueCount(processData, workerColumn) : 0;
            const totalWorkTime = timeColumn ? getSumValue(processData, timeColumn) : 0;
            const avgUPH = totalWorkTime > 0 ? (totalProduction / totalWorkTime).toFixed(2) : 0;
            
            return {
                totalProduction,
                equipmentCount,
                workerCount,
                totalWorkTime,
                avgUPH
            };
        }
        
        // 2) ì„¤ë¹„ë³„ ë¶„ì„
        function analyzeEquipmentData(processData, headers) {
            const equipmentColumn = findColumn(headers, ['ì„¤ë¹„', 'ì¥ë¹„', 'equipment', 'machine']);
            const productionColumn = findColumn(headers, ['ìƒì‚°ìˆ˜ëŸ‰', 'production', 'quantity']);
            const defectColumn = findColumn(headers, ['ë¶ˆëŸ‰', 'ê²°í•¨', 'defect', 'reject']);
            const workerColumn = findColumn(headers, ['ì‘ì—…ì', 'ì¸ì›', 'worker', 'operator']);
            
            if (!equipmentColumn) return null;
            
            const equipmentStats = {};
            
            processData.forEach(row => {
                const equipment = row[equipmentColumn];
                const production = parseFloat(row[productionColumn]) || 0;
                const defect = parseFloat(row[defectColumn]) || 0;
                const worker = row[workerColumn];
                
                if (!equipmentStats[equipment]) {
                    equipmentStats[equipment] = {
                        totalProduction: 0,
                        totalDefect: 0,
                        workers: new Set(),
                        records: 0
                    };
                }
                
                equipmentStats[equipment].totalProduction += production;
                equipmentStats[equipment].totalDefect += defect;
                equipmentStats[equipment].records += 1;
                if (worker) equipmentStats[equipment].workers.add(worker);
            });
            
            // ê° ì„¤ë¹„ë³„ ì§€í‘œ ê³„ì‚°
            Object.keys(equipmentStats).forEach(equipment => {
                const stats = equipmentStats[equipment];
                stats.productivity = (stats.totalProduction / stats.records).toFixed(2);
                stats.operationRate = ((stats.records / processData.length) * 100).toFixed(1);
                stats.defectRate = stats.totalProduction > 0 ? ((stats.totalDefect / stats.totalProduction) * 100).toFixed(2) : 0;
                stats.requiredWorkers = stats.workers.size;
            });
            
            return equipmentStats;
        }
        
        // 3) ì‘ì—…ìë³„ ë¶„ì„
        function analyzeWorkerData(processData, headers) {
            const workerColumn = findColumn(headers, ['ì‘ì—…ì', 'ì¸ì›', 'worker', 'operator']);
            const productionColumn = findColumn(headers, ['ìƒì‚°ìˆ˜ëŸ‰', 'production', 'quantity']);
            const defectColumn = findColumn(headers, ['ë¶ˆëŸ‰', 'ê²°í•¨', 'defect', 'reject']);
            const equipmentColumn = findColumn(headers, ['ì„¤ë¹„', 'ì¥ë¹„', 'equipment', 'machine']);
            
            if (!workerColumn) return null;
            
            const workerStats = {};
            
            processData.forEach(row => {
                const worker = row[workerColumn];
                const production = parseFloat(row[productionColumn]) || 0;
                const defect = parseFloat(row[defectColumn]) || 0;
                const equipment = row[equipmentColumn];
                
                if (!workerStats[worker]) {
                    workerStats[worker] = {
                        totalProduction: 0,
                        totalDefect: 0,
                        equipments: new Set(),
                        records: 0
                    };
                }
                
                workerStats[worker].totalProduction += production;
                workerStats[worker].totalDefect += defect;
                workerStats[worker].records += 1;
                if (equipment) workerStats[worker].equipments.add(equipment);
            });
            
            // ê° ì‘ì—…ìë³„ ì§€í‘œ ê³„ì‚°
            Object.keys(workerStats).forEach(worker => {
                const stats = workerStats[worker];
                stats.productivity = (stats.totalProduction / stats.records).toFixed(2);
                stats.defectRate = stats.totalProduction > 0 ? ((stats.totalDefect / stats.totalProduction) * 100).toFixed(2) : 0;
                stats.equipmentCount = stats.equipments.size;
            });
            
            return workerStats;
        }
        
        // 4) ì‹œê°„ëŒ€ë³„ ë¶„ì„ (24ì‹œê°„)
        function analyzeHourlyData(processData, headers) {
            const timeColumn = findColumn(headers, ['ì‹œê°„', 'ì‘ì—…ì‹œê°„', 'time', 'hour']);
            const productionColumn = findColumn(headers, ['ìƒì‚°ìˆ˜ëŸ‰', 'production', 'quantity']);
            const defectColumn = findColumn(headers, ['ë¶ˆëŸ‰', 'ê²°í•¨', 'defect', 'reject']);
            
            if (!timeColumn) return null;
            
            const hourlyStats = {};
            
            processData.forEach(row => {
                const timeValue = row[timeColumn];
                const hour = extractHour(timeValue);
                const production = parseFloat(row[productionColumn]) || 0;
                const defect = parseFloat(row[defectColumn]) || 0;
                
                if (hour !== null) {
                    if (!hourlyStats[hour]) {
                        hourlyStats[hour] = {
                            totalProduction: 0,
                            totalDefect: 0,
                            records: 0
                        };
                    }
                    
                    hourlyStats[hour].totalProduction += production;
                    hourlyStats[hour].totalDefect += defect;
                    hourlyStats[hour].records += 1;
                }
            });
            
            // ì‹œê°„ëŒ€ë³„ ì§€í‘œ ê³„ì‚°
            Object.keys(hourlyStats).forEach(hour => {
                const stats = hourlyStats[hour];
                stats.productivity = (stats.totalProduction / stats.records).toFixed(2);
                stats.uph = stats.totalProduction; // UPH = Unit Per Hour
                stats.defectRate = stats.totalProduction > 0 ? ((stats.totalDefect / stats.totalProduction) * 100).toFixed(2) : 0;
            });
            
            return hourlyStats;
        }
        
        // 5) êµëŒ€ë³„ ë¶„ì„
        function analyzeShiftData(processData, headers) {
            const shiftColumn = findColumn(headers, ['êµëŒ€', 'ì¡°', 'shift']);
            const timeColumn = findColumn(headers, ['ì‹œê°„', 'ì‘ì—…ì‹œê°„', 'time', 'hour']);
            const productionColumn = findColumn(headers, ['ìƒì‚°ìˆ˜ëŸ‰', 'production', 'quantity']);
            
            let shiftStats = {};
            
            if (shiftColumn) {
                // êµëŒ€ ì»¬ëŸ¼ì´ ìˆëŠ” ê²½ìš°
                processData.forEach(row => {
                    const shift = row[shiftColumn];
                    const production = parseFloat(row[productionColumn]) || 0;
                    
                    if (!shiftStats[shift]) {
                        shiftStats[shift] = { totalProduction: 0, records: 0 };
                    }
                    
                    shiftStats[shift].totalProduction += production;
                    shiftStats[shift].records += 1;
                });
            } else if (timeColumn) {
                // ì‹œê°„ìœ¼ë¡œ êµëŒ€ ì¶”ì •
                processData.forEach(row => {
                    const timeValue = row[timeColumn];
                    const hour = extractHour(timeValue);
                    const production = parseFloat(row[productionColumn]) || 0;
                    
                    if (hour !== null) {
                        let shift = 'ì£¼ê°„ì¡°';
                        if (hour >= 6 && hour < 14) shift = 'ì£¼ê°„ì¡°';
                        else if (hour >= 14 && hour < 22) shift = 'ì˜¤í›„ì¡°';
                        else shift = 'ì•¼ê°„ì¡°';
                        
                        if (!shiftStats[shift]) {
                            shiftStats[shift] = { totalProduction: 0, records: 0 };
                        }
                        
                        shiftStats[shift].totalProduction += production;
                        shiftStats[shift].records += 1;
                    }
                });
            }
            
            // êµëŒ€ë³„ ìƒì‚°ì„± ê³„ì‚°
            Object.keys(shiftStats).forEach(shift => {
                const stats = shiftStats[shift];
                stats.productivity = (stats.totalProduction / stats.records).toFixed(2);
            });
            
            return Object.keys(shiftStats).length > 0 ? shiftStats : null;
        }
        
        // 6) ê·œê²©ë³„ ë¶„ì„
        function analyzeSpecData(processData, headers) {
            const specColumn = findColumn(headers, ['ê·œê²©', 'ëª¨ë¸', 'spec', 'model', 'type']);
            const productionColumn = findColumn(headers, ['ìƒì‚°ìˆ˜ëŸ‰', 'production', 'quantity']);
            const ctColumn = findColumn(headers, ['CT', 'C/T', 'cycle_time', 'cycletime']);
            const defectColumn = findColumn(headers, ['ë¶ˆëŸ‰', 'ê²°í•¨', 'defect', 'reject']);
            const equipmentColumn = findColumn(headers, ['ì„¤ë¹„', 'ì¥ë¹„', 'equipment', 'machine']);
            
            if (!specColumn) return null;
            
            const specStats = {};
            
            processData.forEach(row => {
                const spec = row[specColumn];
                const production = parseFloat(row[productionColumn]) || 0;
                const ct = parseFloat(row[ctColumn]) || 0;
                const defect = parseFloat(row[defectColumn]) || 0;
                const equipment = row[equipmentColumn];
                
                if (!specStats[spec]) {
                    specStats[spec] = {
                        totalProduction: 0,
                        totalDefect: 0,
                        totalCT: 0,
                        equipments: new Set(),
                        records: 0
                    };
                }
                
                specStats[spec].totalProduction += production;
                specStats[spec].totalDefect += defect;
                specStats[spec].totalCT += ct;
                specStats[spec].records += 1;
                if (equipment) specStats[spec].equipments.add(equipment);
            });
            
            // ê·œê²©ë³„ ì§€í‘œ ê³„ì‚°
            Object.keys(specStats).forEach(spec => {
                const stats = specStats[spec];
                stats.productivity = (stats.totalProduction / stats.records).toFixed(2);
                stats.avgCT = stats.records > 0 ? (stats.totalCT / stats.records).toFixed(2) : 0;
                stats.efficiency = stats.avgCT > 0 ? ((60 / stats.avgCT) * 100).toFixed(1) : 0; // íš¨ìœ¨ = (í‘œì¤€ ì‹œê°„ / ì‹¤ì œ ì‹œê°„) * 100
                stats.defectRate = stats.totalProduction > 0 ? ((stats.totalDefect / stats.totalProduction) * 100).toFixed(2) : 0;
                stats.equipmentList = Array.from(stats.equipments);
            });
            
            return specStats;
        }
        
        // 7) ì‘ì—…ìë³„ ì„¤ë¹„ ìš´ì˜ ì‹¤ì 
        function analyzeWorkerEquipmentData(processData, headers) {
            const workerColumn = findColumn(headers, ['ì‘ì—…ì', 'ì¸ì›', 'worker', 'operator']);
            const equipmentColumn = findColumn(headers, ['ì„¤ë¹„', 'ì¥ë¹„', 'equipment', 'machine']);
            const productionColumn = findColumn(headers, ['ìƒì‚°ìˆ˜ëŸ‰', 'production', 'quantity']);
            
            if (!workerColumn || !equipmentColumn) return null;
            
            const workerEquipmentStats = {};
            
            processData.forEach(row => {
                const worker = row[workerColumn];
                const equipment = row[equipmentColumn];
                const production = parseFloat(row[productionColumn]) || 0;
                
                if (!workerEquipmentStats[worker]) {
                    workerEquipmentStats[worker] = {};
                }
                
                if (!workerEquipmentStats[worker][equipment]) {
                    workerEquipmentStats[worker][equipment] = {
                        totalProduction: 0,
                        records: 0
                    };
                }
                
                workerEquipmentStats[worker][equipment].totalProduction += production;
                workerEquipmentStats[worker][equipment].records += 1;
            });
            
            // ì‘ì—…ìë³„ ì„¤ë¹„ ìš´ì˜ ëŒ€ìˆ˜ ê³„ì‚°
            const result = {};
            Object.keys(workerEquipmentStats).forEach(worker => {
                const equipments = workerEquipmentStats[worker];
                result[worker] = {
                    equipmentCount: Object.keys(equipments).length,
                    equipmentDetails: equipments
                };
            });
            
            return result;
        }
        
        // ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ë“¤
        function findColumn(headers, keywords) {
            return headers.find(header => 
                keywords.some(keyword => 
                    header.includes(keyword) || header.toLowerCase().includes(keyword.toLowerCase())
                )
            );
        }
        
        function getUniqueCount(data, column) {
            return new Set(data.map(row => row[column]).filter(val => val)).size;
        }
        
        function getSumValue(data, column) {
            return data.reduce((sum, row) => {
                const val = parseFloat(row[column]);
                return sum + (isNaN(val) ? 0 : val);
            }, 0);
        }
        
        function extractHour(timeValue) {
            if (!timeValue) return null;
            
            // ë‹¤ì–‘í•œ ì‹œê°„ í˜•ì‹ ì²˜ë¦¬
            const timeStr = timeValue.toString();
            
            // HH:MM í˜•ì‹
            const timeMatch = timeStr.match(/(\d{1,2}):(\d{2})/);
            if (timeMatch) {
                return parseInt(timeMatch[1]);
            }
            
            // ìˆ«ìë§Œ ìˆëŠ” ê²½ìš° (ì‹œê°„)
            const numMatch = timeStr.match(/^\d{1,2}$/);
            if (numMatch) {
                const hour = parseInt(timeStr);
                return hour >= 0 && hour <= 23 ? hour : null;
            }
            
            return null;
        }
        
        function analyzeTimeData(processData, dateColumn, productionColumn) {
            // ë‚ ì§œë³„ ìƒì‚°ëŸ‰ ì§‘ê³„
            const dateGroups = {};
            
            processData.forEach(row => {
                const dateValue = row[dateColumn];
                const production = parseFloat(row[productionColumn]);
                
                if (dateValue && !isNaN(production)) {
                    const dateKey = formatDate(dateValue);
                    if (!dateGroups[dateKey]) {
                        dateGroups[dateKey] = [];
                    }
                    dateGroups[dateKey].push(production);
                }
            });
            
            // ë‚ ì§œë³„ í†µê³„ ê³„ì‚°
            const dailyStats = Object.entries(dateGroups).map(([date, productions]) => ({
                date,
                total: productions.reduce((sum, val) => sum + val, 0),
                average: productions.reduce((sum, val) => sum + val, 0) / productions.length,
                count: productions.length
            })).sort((a, b) => new Date(a.date) - new Date(b.date));
            
            return {
                dailyStats,
                bestDay: dailyStats.reduce((max, day) => day.total > max.total ? day : max, dailyStats[0] || {}),
                worstDay: dailyStats.reduce((min, day) => day.total < min.total ? day : min, dailyStats[0] || {})
            };
        }
        
        function analyzeQualityData(processData, qualityColumns) {
            const qualityStats = {};
            
            qualityColumns.forEach(column => {
                const values = processData
                    .map(row => row[column])
                    .filter(val => val !== null && val !== undefined && val !== '');
                
                if (values.length > 0) {
                    qualityStats[column] = {
                        total: values.length,
                        unique: [...new Set(values)],
                        distribution: getValueDistribution(values)
                    };
                }
            });
            
            return qualityStats;
        }
        
        function getValueDistribution(values) {
            const distribution = {};
            values.forEach(val => {
                distribution[val] = (distribution[val] || 0) + 1;
            });
            return distribution;
        }
        
        function formatDate(dateValue) {
            try {
                const date = new Date(dateValue);
                return date.toISOString().split('T')[0]; // YYYY-MM-DD í˜•ì‹
            } catch {
                return dateValue.toString();
            }
        }
        
        function displayProcessModal(processName, analysis, processNumber = null) {
            const modal = document.getElementById('processModal');
            const modalTitle = document.getElementById('modalTitle');
            const modalContent = document.getElementById('modalContent');
            
            const displayTitle = processNumber ? 
                `${processName} (${processNumber}) ê³µì • ìƒì„¸ ë¶„ì„` : 
                `${processName} ê³µì • ìƒì„¸ ë¶„ì„`;
                
            modalTitle.textContent = displayTitle;
            
            let contentHTML = '';
            
            // 1) ìƒì‚° í˜„í™© ì¢…í•©
            if (analysis.productionSummary) {
                const summary = analysis.productionSummary;
                contentHTML += `
                    <h3>ğŸ“Š 1) ìƒì‚° í˜„í™© ì¢…í•©</h3>
                    <div class="stat-grid">
                        <div class="stat-card">
                            <div class="stat-value">${summary.totalProduction.toLocaleString()}</div>
                            <div class="stat-label">ì´ ìƒì‚°ìˆ˜ëŸ‰</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">${summary.equipmentCount}</div>
                            <div class="stat-label">íˆ¬ì…ì„¤ë¹„ ëŒ€ìˆ˜</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">${summary.workerCount}</div>
                            <div class="stat-label">íˆ¬ì…ì¸ì› ìˆ˜</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">${summary.totalWorkTime.toLocaleString()}</div>
                            <div class="stat-label">ì´ ì‘ì—…ì‹œê°„</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">${summary.avgUPH}</div>
                            <div class="stat-label">í‰ê·  UPH</div>
                        </div>
                    </div>
                `;
            }
            
            // 2) ì„¤ë¹„ë³„ ë¶„ì„
            if (analysis.equipmentAnalysis) {
                contentHTML += `<h3>ğŸ”§ 2) ì„¤ë¹„ë³„ ìƒì‚°ì„± ë¶„ì„</h3>`;
                contentHTML += `<div style="overflow-x: auto;">`;
                contentHTML += `<table style="width: 100%; border-collapse: collapse; margin: 10px 0;">`;
                contentHTML += `<thead><tr style="background: #f0f0f0;">
                    <th style="padding: 8px; border: 1px solid #ddd;">ì„¤ë¹„ëª…</th>
                    <th style="padding: 8px; border: 1px solid #ddd;">ìƒì‚°ì„±</th>
                    <th style="padding: 8px; border: 1px solid #ddd;">ê°€ë™ìœ¨(%)</th>
                    <th style="padding: 8px; border: 1px solid #ddd;">ë¶ˆëŸ‰ìœ¨(%)</th>
                    <th style="padding: 8px; border: 1px solid #ddd;">ì†Œìš”ì¸ì›</th>
                </tr></thead><tbody>`;
                
                Object.entries(analysis.equipmentAnalysis).forEach(([equipment, stats]) => {
                    contentHTML += `<tr>
                        <td style="padding: 8px; border: 1px solid #ddd;">${equipment}</td>
                        <td style="padding: 8px; border: 1px solid #ddd;">${stats.productivity}</td>
                        <td style="padding: 8px; border: 1px solid #ddd;">${stats.operationRate}%</td>
                        <td style="padding: 8px; border: 1px solid #ddd;">${stats.defectRate}%</td>
                        <td style="padding: 8px; border: 1px solid #ddd;">${stats.requiredWorkers}ëª…</td>
                    </tr>`;
                });
                contentHTML += `</tbody></table></div>`;
            }
            
            // 3) ì‘ì—…ìë³„ ë¶„ì„
            if (analysis.workerAnalysis) {
                contentHTML += `<h3>ğŸ‘¨â€ğŸ”§ 3) ì‘ì—…ìë³„ ìƒì‚°ì„± ë¶„ì„</h3>`;
                contentHTML += `<div style="overflow-x: auto;">`;
                contentHTML += `<table style="width: 100%; border-collapse: collapse; margin: 10px 0;">`;
                contentHTML += `<thead><tr style="background: #f0f0f0;">
                    <th style="padding: 8px; border: 1px solid #ddd;">ì‘ì—…ì</th>
                    <th style="padding: 8px; border: 1px solid #ddd;">ìƒì‚°ì„±</th>
                    <th style="padding: 8px; border: 1px solid #ddd;">ë¶ˆëŸ‰ìœ¨(%)</th>
                    <th style="padding: 8px; border: 1px solid #ddd;">ì„¤ë¹„ ìš´ì˜ ìˆ˜</th>
                </tr></thead><tbody>`;
                
                Object.entries(analysis.workerAnalysis).forEach(([worker, stats]) => {
                    contentHTML += `<tr>
                        <td style="padding: 8px; border: 1px solid #ddd;">${worker}</td>
                        <td style="padding: 8px; border: 1px solid #ddd;">${stats.productivity}</td>
                        <td style="padding: 8px; border: 1px solid #ddd;">${stats.defectRate}%</td>
                        <td style="padding: 8px; border: 1px solid #ddd;">${stats.equipmentCount}ëŒ€</td>
                    </tr>`;
                });
                contentHTML += `</tbody></table></div>`;
            }
            
            // 4) ì‹œê°„ëŒ€ë³„ ë¶„ì„
            if (analysis.hourlyAnalysis) {
                contentHTML += `<h3>ğŸ• 4) 24ì‹œê°„ ì‹œê°„ëŒ€ë³„ ë¶„ì„</h3>`;
                contentHTML += `<div class="stat-grid">`;
                
                Object.entries(analysis.hourlyAnalysis).sort(([a], [b]) => parseInt(a) - parseInt(b)).forEach(([hour, stats]) => {
                    contentHTML += `
                        <div class="stat-card">
                            <div class="stat-value">${hour}ì‹œ</div>
                            <div class="stat-label">ìƒì‚°ì„±: ${stats.productivity}<br>UPH: ${stats.uph}<br>ë¶ˆëŸ‰ìœ¨: ${stats.defectRate}%</div>
                        </div>
                    `;
                });
                contentHTML += `</div>`;
            }
            
            // 5) êµëŒ€ë³„ ë¶„ì„
            if (analysis.shiftAnalysis) {
                contentHTML += `<h3>â° 5) êµëŒ€ë³„ ìƒì‚°ì„± ë¶„ì„</h3>`;
                contentHTML += `<div class="stat-grid">`;
                
                Object.entries(analysis.shiftAnalysis).forEach(([shift, stats]) => {
                    contentHTML += `
                        <div class="stat-card">
                            <div class="stat-value">${stats.totalProduction.toLocaleString()}</div>
                            <div class="stat-label">${shift}<br>ìƒì‚°ì„±: ${stats.productivity}</div>
                        </div>
                    `;
                });
                contentHTML += `</div>`;
            }
            
            // 6) ê·œê²©ë³„ ë¶„ì„
            if (analysis.specAnalysis) {
                contentHTML += `<h3>ï¿½ 6) ê·œê²©ë³„ ìƒì‚° ì‹¤ì  ë¶„ì„</h3>`;
                contentHTML += `<div style="overflow-x: auto;">`;
                contentHTML += `<table style="width: 100%; border-collapse: collapse; margin: 10px 0;">`;
                contentHTML += `<thead><tr style="background: #f0f0f0;">
                    <th style="padding: 8px; border: 1px solid #ddd;">ê·œê²©</th>
                    <th style="padding: 8px; border: 1px solid #ddd;">ì´ ìƒì‚°ëŸ‰</th>
                    <th style="padding: 8px; border: 1px solid #ddd;">ìƒì‚°ì„±</th>
                    <th style="padding: 8px; border: 1px solid #ddd;">í‰ê·  C/T</th>
                    <th style="padding: 8px; border: 1px solid #ddd;">íš¨ìœ¨(%)</th>
                    <th style="padding: 8px; border: 1px solid #ddd;">ë¶ˆëŸ‰ìœ¨(%)</th>
                    <th style="padding: 8px; border: 1px solid #ddd;">ì ìš© ì„¤ë¹„</th>
                </tr></thead><tbody>`;
                
                Object.entries(analysis.specAnalysis).forEach(([spec, stats]) => {
                    contentHTML += `<tr>
                        <td style="padding: 8px; border: 1px solid #ddd;">${spec}</td>
                        <td style="padding: 8px; border: 1px solid #ddd;">${stats.totalProduction.toLocaleString()}</td>
                        <td style="padding: 8px; border: 1px solid #ddd;">${stats.productivity}</td>
                        <td style="padding: 8px; border: 1px solid #ddd;">${stats.avgCT}ì´ˆ</td>
                        <td style="padding: 8px; border: 1px solid #ddd;">${stats.efficiency}%</td>
                        <td style="padding: 8px; border: 1px solid #ddd;">${stats.defectRate}%</td>
                        <td style="padding: 8px; border: 1px solid #ddd;">${stats.equipmentList.join(', ')}</td>
                    </tr>`;
                });
                contentHTML += `</tbody></table></div>`;
            }
            
            // 7) ì‘ì—…ìë³„ ì„¤ë¹„ ìš´ì˜ ì‹¤ì 
            if (analysis.workerEquipmentAnalysis) {
                contentHTML += `<h3>ğŸ”§ğŸ‘¨â€ğŸ”§ 7) ì‘ì—…ìë³„ ì„¤ë¹„ ìš´ì˜ ì‹¤ì </h3>`;
                contentHTML += `<div style="overflow-x: auto;">`;
                contentHTML += `<table style="width: 100%; border-collapse: collapse; margin: 10px 0;">`;
                contentHTML += `<thead><tr style="background: #f0f0f0;">
                    <th style="padding: 8px; border: 1px solid #ddd;">ì‘ì—…ì</th>
                    <th style="padding: 8px; border: 1px solid #ddd;">ìš´ì˜ ì„¤ë¹„ ìˆ˜</th>
                    <th style="padding: 8px; border: 1px solid #ddd;">ì„¤ë¹„ë³„ ìƒì‚° ì‹¤ì </th>
                </tr></thead><tbody>`;
                
                Object.entries(analysis.workerEquipmentAnalysis).forEach(([worker, stats]) => {
                    const equipmentDetails = Object.entries(stats.equipmentDetails)
                        .map(([eq, data]) => `${eq}(${data.totalProduction})`)
                        .join(', ');
                    
                    contentHTML += `<tr>
                        <td style="padding: 8px; border: 1px solid #ddd;">${worker}</td>
                        <td style="padding: 8px; border: 1px solid #ddd;">${stats.equipmentCount}ëŒ€</td>
                        <td style="padding: 8px; border: 1px solid #ddd;">${equipmentDetails}</td>
                    </tr>`;
                });
                contentHTML += `</tbody></table></div>`;
            }
            
            // ì¢…í•© ì¸ì‚¬ì´íŠ¸
            contentHTML += `
                <h3>ï¿½ ì¢…í•© ë¶„ì„ ì¸ì‚¬ì´íŠ¸</h3>
                <div style="background: #e8f5e8; padding: 15px; border-radius: 6px; margin: 10px 0;">
                    ${generateComprehensiveInsights(analysis)}
                </div>
            `;
            
            modalContent.innerHTML = contentHTML;
            modal.style.display = 'block';
        }
        
        function getProductivityInsights(productivity) {
            let insights = [];
            
            if (productivity.efficiency >= 95) {
                insights.push("âœ… ë°ì´í„° í’ˆì§ˆì´ ë§¤ìš° ìš°ìˆ˜í•©ë‹ˆë‹¤.");
            } else if (productivity.efficiency >= 80) {
                insights.push("âš ï¸ ì¼ë¶€ ë°ì´í„° ëˆ„ë½ì´ ìˆìŠµë‹ˆë‹¤.");
            } else {
                insights.push("âŒ ë°ì´í„° í’ˆì§ˆ ê°œì„ ì´ í•„ìš”í•©ë‹ˆë‹¤.");
            }
            
            const cv = productivity.variability / productivity.average; // ë³€ë™ê³„ìˆ˜
            if (cv < 0.1) {
                insights.push("âœ… ìƒì‚°ëŸ‰ì´ ë§¤ìš° ì•ˆì •ì ì…ë‹ˆë‹¤.");
            } else if (cv < 0.3) {
                insights.push("âš ï¸ ìƒì‚°ëŸ‰ì— ì•½ê°„ì˜ ë³€ë™ì´ ìˆìŠµë‹ˆë‹¤.");
            } else {
                insights.push("âŒ ìƒì‚°ëŸ‰ ë³€ë™ì´ í½ë‹ˆë‹¤. ê³µì • ì•ˆì •ì„± ì ê²€ì´ í•„ìš”í•©ë‹ˆë‹¤.");
            }
            
            return insights.join('<br>');
        }
        
        function generateComprehensiveInsights(analysis) {
            let insights = [];
            
            // ìƒì‚° í˜„í™© ì¸ì‚¬ì´íŠ¸
            if (analysis.productionSummary) {
                const summary = analysis.productionSummary;
                insights.push(`âš¡ ì´ ìƒì‚°ìˆ˜ëŸ‰: ${summary.totalProduction.toLocaleString()}ê°œ, íˆ¬ì…ì„¤ë¹„ ${summary.equipmentCount}ëŒ€, íˆ¬ì…ì¸ì› ${summary.workerCount}ëª…ìœ¼ë¡œ ìš´ì˜`);
                insights.push(`ğŸ“ˆ í‰ê·  UPH: ${summary.avgUPH}, ì´ ì‘ì—…ì‹œê°„: ${summary.totalWorkTime.toLocaleString()}ì‹œê°„`);
            }
            
            // ì„¤ë¹„ ì¸ì‚¬ì´íŠ¸
            if (analysis.equipmentAnalysis) {
                const equipmentEntries = Object.entries(analysis.equipmentAnalysis);
                const bestEquipment = equipmentEntries.reduce((max, [name, stats]) => 
                    parseFloat(stats.productivity) > parseFloat(max.productivity) ? 
                    {name, productivity: stats.productivity} : max, 
                    {name: '', productivity: '0'}
                );
                insights.push(`ğŸ”§ ìµœê³  ì„±ëŠ¥ ì„¤ë¹„: ${bestEquipment.name} (ìƒì‚°ì„±: ${bestEquipment.productivity})`);
            }
            
            // ì‘ì—…ì ì¸ì‚¬ì´íŠ¸
            if (analysis.workerAnalysis) {
                const workerEntries = Object.entries(analysis.workerAnalysis);
                const bestWorker = workerEntries.reduce((max, [name, stats]) => 
                    parseFloat(stats.productivity) > parseFloat(max.productivity) ? 
                    {name, productivity: stats.productivity} : max, 
                    {name: '', productivity: '0'}
                );
                insights.push(`ğŸ‘¨â€ğŸ”§ ìµœê³  ì„±ê³¼ ì‘ì—…ì: ${bestWorker.name} (ìƒì‚°ì„±: ${bestWorker.productivity})`);
            }
            
            // ì‹œê°„ëŒ€ ì¸ì‚¬ì´íŠ¸
            if (analysis.hourlyAnalysis) {
                const hourlyEntries = Object.entries(analysis.hourlyAnalysis);
                const peakHour = hourlyEntries.reduce((max, [hour, stats]) => 
                    parseFloat(stats.productivity) > parseFloat(max.productivity) ? 
                    {hour, productivity: stats.productivity} : max, 
                    {hour: '', productivity: '0'}
                );
                insights.push(`ğŸ• ìµœê³  ìƒì‚°ì„± ì‹œê°„ëŒ€: ${peakHour.hour}ì‹œ (ìƒì‚°ì„±: ${peakHour.productivity})`);
            }
            
            // êµëŒ€ ì¸ì‚¬ì´íŠ¸
            if (analysis.shiftAnalysis) {
                const shiftEntries = Object.entries(analysis.shiftAnalysis);
                const bestShift = shiftEntries.reduce((max, [shift, stats]) => 
                    stats.totalProduction > max.production ? 
                    {shift, production: stats.totalProduction} : max, 
                    {shift: '', production: 0}
                );
                insights.push(`â° ìµœê³  ìƒì‚° êµëŒ€: ${bestShift.shift} (ì´ ìƒì‚°ëŸ‰: ${bestShift.production.toLocaleString()}ê°œ)`);
            }
            
            // ê·œê²© ì¸ì‚¬ì´íŠ¸
            if (analysis.specAnalysis) {
                const specEntries = Object.entries(analysis.specAnalysis);
                const topSpec = specEntries.reduce((max, [spec, stats]) => 
                    stats.totalProduction > max.production ? 
                    {spec, production: stats.totalProduction} : max, 
                    {spec: '', production: 0}
                );
                insights.push(`ğŸ“ ì£¼ë ¥ ê·œê²©: ${topSpec.spec} (ì´ ìƒì‚°ëŸ‰: ${topSpec.production.toLocaleString()}ê°œ)`);
            }
            
            return insights.join('<br>â€¢ ');
        }
        
    </script>
</body>
</html>
